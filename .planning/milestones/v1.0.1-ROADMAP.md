# Milestone v1.0.1: Content Freshness

**Status:** ✅ SHIPPED 2026-01-31
**Phases:** 7-9
**Total Plans:** 6

## Overview

Widgets stay fresh without app launch, feed prioritizes unrated jokes, backend runs in cloud.

## Phases

### Phase 7: Cloud Functions Migration

**Goal**: Rankings aggregation runs automatically in cloud, eliminating manual cron dependency
**Depends on**: Nothing (backend-only, no iOS changes)
**Plans**: 2 plans

Plans:
- [x] 07-01: Create Cloud Functions infrastructure and port aggregation logic
- [x] 07-02: Deploy to Firebase, verify execution, archive local scripts

**Details:**
- Created Firebase Cloud Functions project with Node.js 20 runtime
- Ported aggregation logic from local script to `aggregateRankings` scheduled function
- Added `triggerAggregation` HTTP endpoint for manual triggering
- Deployed to Firebase with Cloud Scheduler (daily at midnight ET)
- Archived local cron scripts to `scripts/archive/` for rollback capability

**Requirements satisfied:** RANK-01, RANK-02, RANK-03

### Phase 8: Feed Content Loading

**Goal**: Full joke catalog loads automatically in background, feed shows unrated jokes first
**Depends on**: Nothing (independent of Phase 7)
**Plans**: 2 plans

Plans:
- [x] 08-01: Infinite scroll infrastructure and remove Load More button
- [x] 08-02: Background catalog loading and unrated-only filtering

**Details:**
- Added `loadMoreIfNeeded()` call in each joke card's `onAppear` for automatic pagination
- Removed LoadMoreButton usage from feed body (kept definition for potential reuse)
- Background catalog loading triggers on first scroll (not app launch)
- Feed filters to unrated jokes only, sorted by popularity score
- Session-rated jokes remain visible until pull-to-refresh
- Pull-to-refresh resets feed state and cancels background loading

**Requirements satisfied:** FEED-01, FEED-02, FEED-03, FEED-04

### Phase 9: Widget Background Refresh

**Goal**: All 6 widgets display fresh Joke of the Day without requiring app launch
**Depends on**: Phase 8 (validates background operation patterns)
**Plans**: 2 plans

Plans:
- [x] 09-01: Widget infrastructure (WidgetDataFetcher + fallback cache)
- [x] 09-02: Provider enhancement + main app wiring + verification

**Details:**
- Created WidgetDataFetcher using Firestore REST API (avoids SDK deadlock #13070)
- Added fallback jokes cache (20 jokes) to SharedStorageService
- Enhanced JokeOfTheDayProvider with 24-hour stale detection
- Cascading fallback: app storage → REST fetch → fallback cache → placeholder
- Main app populates fallback cache on Firestore fetch
- All 6 widgets deep link to joke detail sheet via `mrfunnyjokes://jotd`
- Midnight ET refresh scheduling with timezone-aware calculation

**Requirements satisfied:** WIDGET-01, WIDGET-02, WIDGET-03

---

## Milestone Summary

**Key Decisions:**

- Node.js 20 runtime for Cloud Functions (v18 deprecated)
- Archive local scripts rather than delete (enables rollback)
- Keep LoadMoreButton definition for potential reuse
- Background loading on first scroll (preserves launch performance)
- Session-rated visibility until pull-to-refresh (smoother UX)
- Firestore REST API for widgets (avoids SDK deadlock)
- ET timezone consistency across widget and Cloud Functions
- Widget deep link uses mrfunnyjokes://jotd URL scheme

**Issues Resolved:**

- Widget staleness (widgets now fetch fresh content independently)
- Manual feed pagination (infinite scroll replaces Load More)
- Local cron dependency (Cloud Functions handle aggregation)
- Feed showing already-rated jokes (unrated-first filtering)

**Issues Deferred:**

- Aggressive background refresh (battery drain risk)
- Interactive widget buttons (iOS 18+ only, defer to v2)
- Direct "Hey Siri" voice command (Shortcuts app works reliably)

**Technical Debt Incurred:**

- Local crontab entry needs manual removal by user
- Collection named "weekly_rankings" but UI shows "Monthly" (cosmetic)
- daily_jokes population is manual (consider automating)
- Firebase bundle ID warning in Xcode (informational only)

---

*Archived: 2026-01-31*
*For current project status, see .planning/ROADMAP.md*
