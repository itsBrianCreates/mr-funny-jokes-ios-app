---
phase: 02-lock-screen-widgets
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - MrFunnyJokes/JokeOfTheDayWidget/JokeOfTheDayWidget.swift
  - MrFunnyJokes/JokeOfTheDayWidget/JokeOfTheDayWidgetViews.swift
  - MrFunnyJokes/JokeOfTheDayWidget/LockScreenWidgetViews.swift
autonomous: true

must_haves:
  truths:
    - "Widget gallery shows three lock screen widget options (circular, rectangular, inline)"
    - "Circular widget displays character avatar centered"
    - "Rectangular widget displays character name and joke setup text"
    - "Inline widget displays character name followed by joke text"
    - "Lock screen widgets use transparent background"
    - "Tapping any lock screen widget launches app"
  artifacts:
    - path: "MrFunnyJokes/JokeOfTheDayWidget/LockScreenWidgetViews.swift"
      provides: "AccessoryCircularView, AccessoryRectangularView, AccessoryInlineView"
      min_lines: 60
    - path: "MrFunnyJokes/JokeOfTheDayWidget/JokeOfTheDayWidget.swift"
      provides: "Widget configuration with accessory families"
      contains: ".accessoryCircular"
    - path: "MrFunnyJokes/JokeOfTheDayWidget/JokeOfTheDayWidgetViews.swift"
      provides: "View routing for accessory families"
      contains: "case .accessoryCircular"
  key_links:
    - from: "JokeOfTheDayWidget.swift"
      to: "supportedFamilies"
      via: "Widget configuration modifier"
      pattern: "\\.supportedFamilies.*accessoryCircular.*accessoryRectangular.*accessoryInline"
    - from: "JokeOfTheDayWidgetEntryView"
      to: "LockScreenWidgetViews"
      via: "switch on widgetFamily"
      pattern: "case \\.accessoryCircular"
    - from: "Lock screen views"
      to: "mrfunnyjokes://home"
      via: "widgetURL modifier"
      pattern: "widgetURL.*mrfunnyjokes://home"
---

<objective>
Implement lock screen widget support for all three accessory widget families (circular, rectangular, inline), displaying Joke of the Day content with proper vibrant mode handling.

Purpose: Demonstrates native iOS integration for App Store 4.2.2 compliance. Lock screen widgets provide high-visibility presence for the app.

Output: Three new lock screen widget types available in iOS widget gallery, all using existing JokeOfTheDayProvider for content.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-lock-screen-widgets/02-RESEARCH.md
@.planning/phases/02-lock-screen-widgets/02-CONTEXT.md

# Existing widget implementation
@MrFunnyJokes/JokeOfTheDayWidget/JokeOfTheDayWidget.swift
@MrFunnyJokes/JokeOfTheDayWidget/JokeOfTheDayWidgetViews.swift
@MrFunnyJokes/JokeOfTheDayWidget/JokeOfTheDayProvider.swift
@MrFunnyJokes/Shared/SharedJokeOfTheDay.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create lock screen widget views</name>
  <files>MrFunnyJokes/JokeOfTheDayWidget/LockScreenWidgetViews.swift</files>
  <action>
Create new file LockScreenWidgetViews.swift with three view structs:

1. **AccessoryCircularView** - Per CONTEXT.md: display character avatar only
   - Use `AccessoryWidgetBackground()` for standard translucent circle background
   - Center the character avatar image using existing `characterImageName(for:)` helper
   - Make image resizable with `.scaledToFit()` and slight padding (~4pt inset)
   - Add fallback SF Symbol `face.smiling` if no character image
   - Add `.widgetURL(URL(string: "mrfunnyjokes://home"))` for tap handling

2. **AccessoryRectangularView** - Per CONTEXT.md: character name + setup text
   - VStack with leading alignment, 2pt spacing
   - Character name as headline/bold font, lineLimit(1)
   - Joke setup as caption font, lineLimit(2) - truncates with ellipsis per CONTEXT.md
   - Use existing `characterDisplayName(for:)` helper
   - Frame with maxWidth: .infinity, alignment: .leading
   - Add `.widgetURL(URL(string: "mrfunnyjokes://home"))`

3. **AccessoryInlineView** - Per CONTEXT.md: "Mr. Funny: Why did the..."
   - Use `ViewThatFits` for adaptive text (per RESEARCH.md pitfall #3)
   - First option: full format "\(characterDisplayName): \(joke.setup)"
   - Fallback option: just the setup text (character name gets priority, but if both don't fit, show what we can)
   - Add `.widgetURL(URL(string: "mrfunnyjokes://home"))`

All views take `joke: SharedJokeOfTheDay` parameter.

Import SwiftUI and WidgetKit at top of file.
  </action>
  <verify>File exists and compiles: `xcodebuild -project MrFunnyJokes.xcodeproj -scheme JokeOfTheDayWidgetExtension -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | tail -20`</verify>
  <done>LockScreenWidgetViews.swift contains AccessoryCircularView, AccessoryRectangularView, and AccessoryInlineView with proper layout per CONTEXT.md decisions</done>
</task>

<task type="auto">
  <name>Task 2: Update widget configuration and view routing</name>
  <files>MrFunnyJokes/JokeOfTheDayWidget/JokeOfTheDayWidget.swift, MrFunnyJokes/JokeOfTheDayWidget/JokeOfTheDayWidgetViews.swift</files>
  <action>
**In JokeOfTheDayWidget.swift:**

1. Update `supportedFamilies` modifier to add three accessory families:
   ```swift
   .supportedFamilies([
       // Home screen (existing)
       .systemSmall, .systemMedium, .systemLarge,
       // Lock screen (new)
       .accessoryCircular, .accessoryRectangular, .accessoryInline
   ])
   ```

2. Update `containerBackground(for: .widget)` to handle both contexts:
   - For accessory families: use empty/transparent background (lock screen wallpaper shows through)
   - For system families: keep existing `Color(UIColor.systemBackground)`

   Since containerBackground is on the entry view, we need to move this logic to JokeOfTheDayWidgetEntryView or use a conditional approach. The cleanest pattern from RESEARCH.md:

   Keep the current containerBackground but have the EntryView handle background internally per family, OR update containerBackground to be conditional based on context. Prefer keeping the existing approach simple - accessory widgets will naturally be transparent if we don't apply a background color to them.

   Actually, the current setup already works - iOS will handle vibrant mode for accessory widgets automatically. Just add the families to supportedFamilies.

**In JokeOfTheDayWidgetViews.swift:**

1. Add import for the new views (if needed - they're in same target, should auto-discover)

2. Update `JokeOfTheDayWidgetEntryView` switch statement to add three new cases:
   ```swift
   case .accessoryCircular:
       AccessoryCircularView(joke: entry.joke)
   case .accessoryRectangular:
       AccessoryRectangularView(joke: entry.joke)
   case .accessoryInline:
       AccessoryInlineView(joke: entry.joke)
   ```
   Add these cases BEFORE the `default` case.

3. Add SwiftUI Previews for lock screen widgets at the bottom of JokeOfTheDayWidgetViews.swift:
   - Preview for accessoryCircular with Mr. Funny joke
   - Preview for accessoryRectangular with Mr. Love joke
   - Preview for accessoryInline with Mr. Bad joke

   Use the existing preview pattern with `#Preview` macro and timeline entries.
  </action>
  <verify>Build succeeds and previews render: `xcodebuild -project MrFunnyJokes.xcodeproj -scheme JokeOfTheDayWidgetExtension -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | grep -E "(Build Succeeded|error:)"</verify>
  <done>Widget configuration includes all 6 families (3 home + 3 lock screen), view routing handles all cases, previews exist for lock screen widgets</done>
</task>

<task type="auto">
  <name>Task 3: Build and verify in simulator</name>
  <files>None - verification only</files>
  <action>
1. Build the widget extension target:
   ```
   xcodebuild -project MrFunnyJokes.xcodeproj -scheme JokeOfTheDayWidgetExtension -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build
   ```

2. If any compilation errors, fix them in the relevant files.

3. Run the main app target to launch simulator:
   ```
   xcodebuild -project MrFunnyJokes.xcodeproj -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build
   ```

4. Verify the widget extension scheme builds cleanly with no warnings about missing cases or deprecated APIs.

Note: Full lock screen widget testing requires physical device (Phase 02-02 verification plan). Simulator build verification confirms code compiles correctly.
  </action>
  <verify>Both schemes build successfully: `xcodebuild -project MrFunnyJokes.xcodeproj -scheme JokeOfTheDayWidgetExtension -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | grep "BUILD SUCCEEDED" || echo "Build failed"`</verify>
  <done>Widget extension and main app build successfully with lock screen widget support</done>
</task>

</tasks>

<verification>
1. LockScreenWidgetViews.swift exists with 3 view structs (AccessoryCircular, AccessoryRectangular, AccessoryInline)
2. JokeOfTheDayWidget.swift supportedFamilies includes .accessoryCircular, .accessoryRectangular, .accessoryInline
3. JokeOfTheDayWidgetEntryView switch handles all 6 widget families
4. Widget extension target builds without errors
5. Main app target builds without errors
6. SwiftUI previews exist for all 3 lock screen widget types
</verification>

<success_criteria>
- All three accessory widget families are registered in widget configuration
- Each accessory family has a dedicated view with correct layout per CONTEXT.md
- View routing correctly dispatches to lock screen views based on widgetFamily
- Deep linking via widgetURL is configured for all lock screen widgets
- Code compiles without errors or warnings
</success_criteria>

<output>
After completion, create `.planning/phases/02-lock-screen-widgets/02-01-SUMMARY.md`
</output>
