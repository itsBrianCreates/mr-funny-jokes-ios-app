---
phase: 07-cloud-functions-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - functions/package.json
  - functions/index.js
  - firebase.json
  - .firebaserc
autonomous: true

must_haves:
  truths:
    - "Cloud Functions project structure exists at functions/"
    - "Aggregation logic matches existing scripts/aggregate-weekly-rankings.js exactly"
    - "HTTP endpoint and scheduled function both use shared aggregation logic"
  artifacts:
    - path: "functions/package.json"
      provides: "Node.js 20 project with firebase-functions and firebase-admin"
      contains: "firebase-functions"
    - path: "functions/index.js"
      provides: "Scheduled function + HTTP trigger with aggregation logic"
      exports: ["aggregateRankings", "triggerAggregation"]
    - path: "firebase.json"
      provides: "Firebase project configuration pointing to functions/"
      contains: "functions"
    - path: ".firebaserc"
      provides: "Firebase project alias for mr-funny-jokes"
      contains: "mr-funny-jokes"
  key_links:
    - from: "functions/index.js"
      to: "Firestore rating_events collection"
      via: "db.collection query"
      pattern: "rating_events"
    - from: "functions/index.js"
      to: "Firestore weekly_rankings collection"
      via: "db.collection set"
      pattern: "weekly_rankings"
---

<objective>
Create Cloud Functions infrastructure and port aggregation logic

Purpose: Set up Firebase Cloud Functions project structure and migrate the existing weekly rankings aggregation script to a scheduled Cloud Function with HTTP trigger.
Output: Complete functions/ directory with deployable aggregation function code
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-cloud-functions-migration/07-CONTEXT.md
@.planning/phases/07-cloud-functions-migration/07-RESEARCH.md
@scripts/aggregate-weekly-rankings.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Cloud Functions project structure</name>
  <files>
    functions/package.json
    firebase.json
    .firebaserc
  </files>
  <action>
Create the Cloud Functions project infrastructure:

1. Create `functions/` directory at project root
2. Create `functions/package.json`:
   - name: "mr-funny-jokes-functions"
   - engines.node: "20" (required for firebase-functions v7)
   - dependencies: firebase-admin@^13.0.0, firebase-functions@^7.0.0
   - scripts: serve (emulators), deploy (firebase deploy --only functions)

3. Create `firebase.json` at project root:
   - functions.source: "functions"
   - functions.runtime: "nodejs20"

4. Create `.firebaserc` at project root:
   - projects.default: "mr-funny-jokes"

5. Run `cd functions && npm install` to install dependencies

Use exact package.json template from 07-RESEARCH.md.
  </action>
  <verify>
    - `ls functions/package.json` exists
    - `ls functions/node_modules/firebase-functions` exists
    - `cat firebase.json` shows functions config
    - `cat .firebaserc` shows project alias
  </verify>
  <done>Cloud Functions project structure complete with dependencies installed</done>
</task>

<task type="auto">
  <name>Task 2: Port aggregation logic to Cloud Function</name>
  <files>
    functions/index.js
  </files>
  <action>
Create `functions/index.js` that ports the exact logic from `scripts/aggregate-weekly-rankings.js`:

**Use Cloud Functions v2 imports:**
- `onSchedule` from `firebase-functions/v2/scheduler`
- `onRequest` from `firebase-functions/v2/https`
- `logger` from `firebase-functions`
- `initializeApp` from `firebase-admin/app`
- `getFirestore`, `FieldValue`, `Timestamp` from `firebase-admin/firestore`

**Initialize at module scope (not inside handlers):**
```javascript
initializeApp();
const db = getFirestore();
```

**Port helper functions verbatim from existing script:**
- `getCurrentWeekId()` - ISO week calculation in Eastern Time
- `getWeekDateRange(weekId)` - Convert week ID to date range
- `aggregateRatings(events)` - Count hilarious (4-5) and horrible (1-2) ratings
- `rankTopN(counts, n)` - Sort and rank top N jokes

**Add new functions:**
- `fetchRatingEvents(weekId)` - Query rating_events by week_id
- `saveWeeklyRankings(weekId, rankings)` - Write to weekly_rankings collection
- `runAggregation(weekId)` - Orchestrates the full aggregation (shared by both triggers)

**Export two functions:**
1. `aggregateRankings` - onSchedule with:
   - schedule: "0 0 * * *" (daily at midnight)
   - timeZone: "America/New_York"
   - retryCount: 3
   - memory: "256MiB"

2. `triggerAggregation` - onRequest for manual triggering:
   - Accepts optional ?week=YYYY-WNN query param
   - Returns JSON with success status and result

**Critical:** Match existing aggregation logic exactly:
- rating >= 4 is "hilarious"
- rating <= 2 is "horrible"
- rating == 3 is neutral (not counted)
- Output format matches existing weekly_rankings documents

Use complete index.js template from 07-RESEARCH.md as reference, adapting field names to match existing script output format.
  </action>
  <verify>
    - `cat functions/index.js | grep "onSchedule"` shows scheduled function
    - `cat functions/index.js | grep "onRequest"` shows HTTP function
    - `cat functions/index.js | grep "rating_events"` shows correct collection
    - `cat functions/index.js | grep "weekly_rankings"` shows correct collection
    - `cat functions/index.js | grep "America/New_York"` shows timezone
  </verify>
  <done>Cloud Function code complete with scheduled and HTTP triggers, matching existing aggregation logic</done>
</task>

<task type="auto">
  <name>Task 3: Validate function locally with emulator</name>
  <files>none (validation only)</files>
  <action>
Test the Cloud Function code locally using Firebase emulators:

1. Start emulators: `cd functions && npm run serve` (runs `firebase emulators:start --only functions`)
   - Note: Scheduled function won't auto-trigger in emulator, but we can verify code loads

2. If emulator fails to start, verify:
   - firebase-tools is installed globally (`npm list -g firebase-tools`)
   - If not, install: `npm install -g firebase-tools`

3. Test HTTP endpoint manually (in separate terminal):
   - `curl http://localhost:5001/mr-funny-jokes/us-central1/triggerAggregation`
   - Expected: JSON response with success:true or success:false (depending on emulator Firestore state)

4. Check emulator output for any syntax errors or import issues

Note: Emulator tests against local emulated Firestore (empty), so expect empty results. The goal is to verify code loads and runs without errors.
  </action>
  <verify>
    - Firebase emulator starts without errors
    - HTTP endpoint responds (even if with empty data)
    - No import errors or syntax errors in emulator logs
  </verify>
  <done>Cloud Function code validated locally - ready for deployment</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. `functions/` directory exists with package.json, index.js, node_modules
2. `firebase.json` and `.firebaserc` exist at project root
3. Code compiles and loads in Firebase emulator
4. HTTP endpoint is callable (even with empty local data)
</verification>

<success_criteria>
- Cloud Functions infrastructure complete and dependencies installed
- Aggregation logic ported exactly from existing script
- Code validated locally with Firebase emulator
- Ready for deployment in Plan 02
</success_criteria>

<output>
After completion, create `.planning/phases/07-cloud-functions-migration/07-01-SUMMARY.md`
</output>
