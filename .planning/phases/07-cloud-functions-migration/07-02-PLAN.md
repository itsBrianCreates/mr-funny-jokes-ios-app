---
phase: 07-cloud-functions-migration
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - scripts/archive/aggregate-weekly-rankings.js
  - scripts/archive/run-aggregation.sh
autonomous: false

must_haves:
  truths:
    - "Cloud Functions deployed to Firebase successfully"
    - "Scheduled function runs daily at midnight ET without manual intervention"
    - "HTTP endpoint is callable for manual triggering"
    - "Cloud function logs visible in Firebase Console"
    - "Local cron scripts archived after deployment verified"
  artifacts:
    - path: "Firebase Cloud Functions (remote)"
      provides: "aggregateRankings scheduled function"
      contains: "deployed to us-central1"
    - path: "Firebase Cloud Functions (remote)"
      provides: "triggerAggregation HTTP endpoint"
      contains: "https://us-central1-mr-funny-jokes.cloudfunctions.net/triggerAggregation"
    - path: "scripts/archive/aggregate-weekly-rankings.js"
      provides: "Archived local script (retired)"
      contains: "moved from scripts/"
  key_links:
    - from: "Cloud Scheduler"
      to: "aggregateRankings function"
      via: "cron trigger at 0 0 * * *"
      pattern: "daily midnight ET"
    - from: "HTTP request"
      to: "triggerAggregation function"
      via: "public URL"
      pattern: "cloudfunctions.net"
---

<objective>
Deploy Cloud Functions and verify scheduled execution

Purpose: Deploy the aggregation function to Firebase, verify it runs correctly, test manual HTTP trigger, and archive local cron scripts after confirming cloud execution works.
Output: Live Cloud Functions running rankings aggregation, local scripts archived
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-cloud-functions-migration/07-CONTEXT.md
@.planning/phases/07-cloud-functions-migration/07-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Deploy Cloud Functions to Firebase</name>
  <files>none (deployment only)</files>
  <action>
Deploy the Cloud Functions to Firebase production:

1. Ensure firebase-tools CLI is installed and authenticated:
   - `firebase --version` (should be installed)
   - `firebase login` (if not already authenticated)

2. Deploy functions:
   ```bash
   cd /Users/brianvanaski/Documents/Code/mr-funny-jokes-ios-app
   firebase deploy --only functions
   ```

3. Expected output:
   - "Function aggregateRankings scheduled to run: 0 0 * * * (America/New_York)"
   - "Function triggerAggregation: https://us-central1-mr-funny-jokes.cloudfunctions.net/triggerAggregation"

4. If deployment fails:
   - Check Cloud Scheduler API is enabled (deployment will prompt if needed)
   - Verify billing is enabled on Firebase project (required for scheduled functions)
   - Check for any code errors in deployment output

Note: First deployment may take 2-3 minutes as Firebase provisions resources.
  </action>
  <verify>
    - `firebase deploy --only functions` completes successfully
    - Output shows both functions deployed
    - HTTP endpoint URL is displayed
  </verify>
  <done>Cloud Functions deployed to Firebase successfully</done>
</task>

<task type="auto">
  <name>Task 2: Test HTTP endpoint and verify function works</name>
  <files>none (testing only)</files>
  <action>
Test the deployed Cloud Functions:

1. Test HTTP endpoint (manual trigger):
   ```bash
   curl https://us-central1-mr-funny-jokes.cloudfunctions.net/triggerAggregation
   ```
   Expected response: JSON with success:true and result object showing:
   - weekId: current week (e.g., "2026-W05")
   - eventsProcessed: number
   - hilariousTop10Count: number
   - horribleTop10Count: number

2. Test with specific week parameter:
   ```bash
   curl "https://us-central1-mr-funny-jokes.cloudfunctions.net/triggerAggregation?week=2026-W04"
   ```

3. Verify in Firebase Console:
   - Go to Firebase Console > Functions
   - Check both functions appear in list
   - Check logs for triggerAggregation showing recent execution

4. Verify Firestore data was updated:
   - Go to Firebase Console > Firestore
   - Check weekly_rankings collection
   - Verify document exists with correct structure (hilarious/horrible arrays, computed_at timestamp)

5. Compare output with local script run:
   - The rankings should match what local script would produce for same week
  </action>
  <verify>
    - HTTP endpoint returns success:true response
    - Firebase Console shows both functions deployed
    - Function logs show successful execution
    - Firestore weekly_rankings document updated with correct structure
  </verify>
  <done>Cloud Functions working correctly - HTTP trigger tested, Firestore data verified</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Cloud Functions deployment:
- aggregateRankings: Scheduled function running daily at midnight ET
- triggerAggregation: HTTP endpoint for manual triggering
  </what-built>
  <how-to-verify>
1. Open Firebase Console: https://console.firebase.google.com/project/mr-funny-jokes/functions
2. Verify both functions appear in the Functions list
3. Click on aggregateRankings > View logs - confirm no errors
4. Check Firestore > weekly_rankings collection - verify recent document has:
   - hilarious array with ranked jokes
   - horrible array with ranked jokes
   - computed_at timestamp from HTTP test

5. (Optional) Wait for next midnight ET to verify scheduled execution appears in logs
  </how-to-verify>
  <resume-signal>Type "verified" if functions appear correctly in Firebase Console, or describe any issues</resume-signal>
</task>

<task type="auto">
  <name>Task 3: Archive local cron scripts</name>
  <files>
    scripts/archive/aggregate-weekly-rankings.js
    scripts/archive/run-aggregation.sh
  </files>
  <action>
Archive the local cron scripts now that Cloud Functions are handling aggregation:

1. Create archive directory:
   ```bash
   mkdir -p scripts/archive
   ```

2. Move scripts to archive:
   ```bash
   mv scripts/aggregate-weekly-rankings.js scripts/archive/
   mv scripts/run-aggregation.sh scripts/archive/
   ```

3. Add README to archive explaining why scripts were archived:
   ```bash
   echo "# Archived Scripts

These scripts were replaced by Firebase Cloud Functions on $(date +%Y-%m-%d).

- aggregate-weekly-rankings.js - Now handled by aggregateRankings Cloud Function
- run-aggregation.sh - No longer needed (Cloud Scheduler triggers function)

Cloud Functions location: functions/index.js
" > scripts/archive/README.md
   ```

4. If local cron job exists, disable it:
   - Check for any crontab entries: `crontab -l | grep aggregation`
   - If found, remove the entry (user can do this manually if needed)

Note: Keep archive for rollback purposes. Delete after v1.0.1 release if desired.
  </action>
  <verify>
    - `ls scripts/archive/aggregate-weekly-rankings.js` exists
    - `ls scripts/archive/run-aggregation.sh` exists
    - `ls scripts/aggregate-weekly-rankings.js` no longer exists (moved)
    - `cat scripts/archive/README.md` shows archive explanation
  </verify>
  <done>Local cron scripts archived - Cloud Functions are now the source of truth for rankings aggregation</done>
</task>

</tasks>

<verification>
After completing all tasks:
1. Cloud Functions deployed and visible in Firebase Console
2. HTTP endpoint tested and returning correct data
3. Firestore weekly_rankings updated by Cloud Function
4. Local scripts archived to scripts/archive/
5. Requirements RANK-01, RANK-02, RANK-03 satisfied
</verification>

<success_criteria>
- Cloud Functions deployed to Firebase
- HTTP trigger works correctly
- Scheduled function configured for daily midnight ET
- Function logs visible in Firebase Console
- Local cron scripts archived
- Phase 7 requirements complete
</success_criteria>

<output>
After completion, create `.planning/phases/07-cloud-functions-migration/07-02-SUMMARY.md`
</output>
