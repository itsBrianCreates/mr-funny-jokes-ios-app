---
phase: 20-event-instrumentation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift
  - MrFunnyJokes/MrFunnyJokes/ViewModels/CharacterDetailViewModel.swift
  - MrFunnyJokes/MrFunnyJokes/App/MrFunnyJokesApp.swift
autonomous: true

must_haves:
  truths:
    - "Rating a joke as Hilarious or Horrible logs a joke_rated event with joke ID, character name, and rating value"
    - "Copying a joke logs a joke_shared event with joke ID and method 'copy'"
    - "Sharing a joke logs a joke_shared event with joke ID and method 'share'"
    - "Selecting a character from the home screen carousel logs a character_selected event with the character ID"
  artifacts:
    - path: "MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift"
      provides: "Analytics calls in rateJoke, shareJoke, copyJoke"
      contains: "AnalyticsService.shared.logJokeRated"
    - path: "MrFunnyJokes/MrFunnyJokes/ViewModels/CharacterDetailViewModel.swift"
      provides: "Analytics calls in rateJoke, shareJoke, copyJoke"
      contains: "AnalyticsService.shared.logJokeRated"
    - path: "MrFunnyJokes/MrFunnyJokes/App/MrFunnyJokesApp.swift"
      provides: "Analytics call in onCharacterTap closure"
      contains: "AnalyticsService.shared.logCharacterSelected"
  key_links:
    - from: "MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift"
      to: "MrFunnyJokes/MrFunnyJokes/Services/AnalyticsService.swift"
      via: "AnalyticsService.shared method calls"
      pattern: "AnalyticsService\\.shared\\.log"
    - from: "MrFunnyJokes/MrFunnyJokes/ViewModels/CharacterDetailViewModel.swift"
      to: "MrFunnyJokes/MrFunnyJokes/Services/AnalyticsService.swift"
      via: "AnalyticsService.shared method calls"
      pattern: "AnalyticsService\\.shared\\.log"
    - from: "MrFunnyJokes/MrFunnyJokes/App/MrFunnyJokesApp.swift"
      to: "MrFunnyJokes/MrFunnyJokes/Services/AnalyticsService.swift"
      via: "AnalyticsService.shared.logCharacterSelected call"
      pattern: "AnalyticsService\\.shared\\.logCharacterSelected"
---

<objective>
Wire AnalyticsService event calls into the three key user interaction sites: joke rating, joke sharing/copying, and character selection.

Purpose: Complete Firebase Analytics instrumentation so user actions produce events visible in Firebase Analytics Debug View.
Output: Three modified files with analytics calls at all interaction points.
</objective>

<execution_context>
@/Users/brianvanaski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brianvanaski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-analytics-foundation/19-01-SUMMARY.md
@MrFunnyJokes/MrFunnyJokes/Services/AnalyticsService.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add analytics calls to JokeViewModel and CharacterDetailViewModel</name>
  <files>MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift, MrFunnyJokes/MrFunnyJokes/ViewModels/CharacterDetailViewModel.swift</files>
  <action>
Wire AnalyticsService.shared calls into 6 methods across 2 ViewModels. All calls are fire-and-forget (no async, no error handling needed — Analytics.logEvent is synchronous and thread-safe).

**JokeViewModel.swift** — 3 methods:

1. `rateJoke(_ joke: Joke, rating: Int)` (~line 817): Inside the `else` branch (when rating != 0), after clamping the rating, add:
   ```swift
   let ratingName = clampedRating == 5 ? "hilarious" : "horrible"
   AnalyticsService.shared.logJokeRated(
       jokeId: joke.firestoreId ?? joke.id.uuidString,
       character: joke.character ?? "unknown",
       rating: ratingName
   )
   ```
   Place this AFTER `sessionRatedJokeIds.insert(key)` and BEFORE `storage.saveRating(...)`. Only binary ratings exist (1 or 5), so both values get logged. The rating parameter is String per Phase 19 decision.

2. `shareJoke(_ joke: Joke)` (~line 1003): After the haptic call, add:
   ```swift
   AnalyticsService.shared.logJokeShared(
       jokeId: joke.firestoreId ?? joke.id.uuidString,
       method: "share"
   )
   ```
   Place this right after `HapticManager.shared.success()`.

3. `copyJoke(_ joke: Joke)` (~line 1049): After the haptic call, add:
   ```swift
   AnalyticsService.shared.logJokeShared(
       jokeId: joke.firestoreId ?? joke.id.uuidString,
       method: "copy"
   )
   ```
   Place this right after `HapticManager.shared.success()`.

**CharacterDetailViewModel.swift** — 3 methods:

1. `rateJoke(_ joke: Joke, rating: Int)` (~line 226): Inside the `else` branch (when rating != 0), after clamping the rating, add the same analytics call:
   ```swift
   let ratingName = clampedRating == 5 ? "hilarious" : "horrible"
   AnalyticsService.shared.logJokeRated(
       jokeId: joke.firestoreId ?? joke.id.uuidString,
       character: joke.character ?? "unknown",
       rating: ratingName
   )
   ```
   Place this AFTER `storage.saveRating(...)` and BEFORE the Firestore sync Task block.

2. `shareJoke(_ joke: Joke)` (~line 338): After the haptic call, add:
   ```swift
   AnalyticsService.shared.logJokeShared(
       jokeId: joke.firestoreId ?? joke.id.uuidString,
       method: "share"
   )
   ```

3. `copyJoke(_ joke: Joke)` (~line 375): After the haptic call, add:
   ```swift
   AnalyticsService.shared.logJokeShared(
       jokeId: joke.firestoreId ?? joke.id.uuidString,
       method: "copy"
   )
   ```

**Important:** Use `joke.firestoreId ?? joke.id.uuidString` for jokeId parameter everywhere — this matches the pattern used throughout the codebase for stable joke identification.
  </action>
  <verify>Build the project: `cd MrFunnyJokes && xcodebuild -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | tail -5`. Should show BUILD SUCCEEDED with zero errors. Then grep to confirm all 6 call sites: `grep -n "AnalyticsService.shared.log" MrFunnyJokes/ViewModels/JokeViewModel.swift MrFunnyJokes/ViewModels/CharacterDetailViewModel.swift` should return 6 lines (3 per file).</verify>
  <done>JokeViewModel has logJokeRated in rateJoke, logJokeShared in shareJoke and copyJoke. CharacterDetailViewModel has the same 3 calls. All 6 analytics calls use jokeId from firestoreId with UUID fallback.</done>
</task>

<task type="auto">
  <name>Task 2: Add character selection analytics to home screen carousel</name>
  <files>MrFunnyJokes/MrFunnyJokes/App/MrFunnyJokesApp.swift</files>
  <action>
Wire AnalyticsService.shared.logCharacterSelected into the character tap handler.

In `MrFunnyJokesApp.swift`, find the `onCharacterTap` closure in the `homeTab` computed property (~line 245):

```swift
onCharacterTap: { character in
    navigationPath.append(character)
}
```

Add the analytics call BEFORE the navigation:

```swift
onCharacterTap: { character in
    AnalyticsService.shared.logCharacterSelected(characterId: character.id)
    navigationPath.append(character)
}
```

The character.id is the string identifier (e.g., "mr_funny", "mr_potty") which matches the valid character IDs documented in CLAUDE.md.
  </action>
  <verify>Build the project: `cd MrFunnyJokes && xcodebuild -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | tail -5`. Should show BUILD SUCCEEDED. Then grep: `grep -n "AnalyticsService.shared.logCharacterSelected" MrFunnyJokes/App/MrFunnyJokesApp.swift` should return 1 line.</verify>
  <done>Tapping a character in the home screen carousel logs a character_selected event with the character's ID before navigating to the character detail view.</done>
</task>

</tasks>

<verification>
1. Project builds with zero errors after all changes
2. `grep -rn "AnalyticsService.shared.log" MrFunnyJokes/MrFunnyJokes/` returns exactly 7 call sites (3 in JokeViewModel, 3 in CharacterDetailViewModel, 1 in MrFunnyJokesApp)
3. No analytics calls in widget extension code (per architectural decision — Firebase SDK causes deadlock #13070)
4. All jokeId parameters use `firestoreId ?? id.uuidString` pattern for stable identification
5. Rating analytics use String values ("hilarious"/"horrible") per Phase 19 decision
6. Events can be verified in Firebase Analytics Debug View with -FIRAnalyticsDebugEnabled launch argument
</verification>

<success_criteria>
- Rating a joke calls AnalyticsService.shared.logJokeRated with joke ID, character, and "hilarious"/"horrible"
- Sharing a joke calls AnalyticsService.shared.logJokeShared with joke ID and method "share"
- Copying a joke calls AnalyticsService.shared.logJokeShared with joke ID and method "copy"
- Selecting a character calls AnalyticsService.shared.logCharacterSelected with character ID
- App builds successfully with all analytics calls in place
</success_criteria>

<output>
After completion, create `.planning/phases/20-event-instrumentation/20-01-SUMMARY.md`
</output>
