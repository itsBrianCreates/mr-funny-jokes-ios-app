---
phase: 09-widget-background-refresh
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - MrFunnyJokes/JokeOfTheDayWidget/WidgetDataFetcher.swift
  - MrFunnyJokes/Shared/SharedStorageService.swift
  - MrFunnyJokes/Shared/SharedJokeOfTheDay.swift
autonomous: true

must_haves:
  truths:
    - "Widget can fetch JOTD directly from Firestore REST API without Firebase SDK"
    - "Widget can store and retrieve fallback jokes from App Groups cache"
    - "Placeholder message shows 'Open Mr. Funny Jokes to get started!' for empty cache"
  artifacts:
    - path: "MrFunnyJokes/JokeOfTheDayWidget/WidgetDataFetcher.swift"
      provides: "URLSession-based Firestore REST API fetch for JOTD"
      min_lines: 80
    - path: "MrFunnyJokes/Shared/SharedStorageService.swift"
      provides: "Fallback jokes cache methods"
      contains: "fallbackJokesCache"
    - path: "MrFunnyJokes/Shared/SharedJokeOfTheDay.swift"
      provides: "Updated placeholder message"
      contains: "Open Mr. Funny Jokes to get started"
  key_links:
    - from: "WidgetDataFetcher.swift"
      to: "Firestore REST API"
      via: "URLSession async/await"
      pattern: "firestore.googleapis.com"
    - from: "SharedStorageService.swift"
      to: "App Groups UserDefaults"
      via: "sharedDefaults"
      pattern: "fallbackJokesCache"
---

<objective>
Create the infrastructure for widget background refresh: a REST API fetcher that bypasses Firebase SDK (avoiding deadlock issues) and a fallback jokes cache for offline scenarios.

Purpose: Enable widgets to fetch fresh JOTD data directly without depending on the main app, and provide graceful degradation when network is unavailable.
Output: WidgetDataFetcher.swift (new), enhanced SharedStorageService.swift, updated SharedJokeOfTheDay.swift
</objective>

<execution_context>
@/Users/brianvanaski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brianvanaski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-widget-background-refresh/09-RESEARCH.md
@MrFunnyJokes/Shared/SharedStorageService.swift
@MrFunnyJokes/Shared/SharedJokeOfTheDay.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create WidgetDataFetcher with Firestore REST API</name>
  <files>MrFunnyJokes/JokeOfTheDayWidget/WidgetDataFetcher.swift</files>
  <action>
Create a new file `WidgetDataFetcher.swift` in the JokeOfTheDayWidget target with:

1. Static struct with async function `fetchJokeOfTheDay() -> SharedJokeOfTheDay?`

2. Implementation:
   - Project ID: "mr-funny-jokes"
   - First fetch today's document from `daily_jokes/{YYYY-MM-DD}` collection
   - Use ET timezone for date calculation: `TimeZone(identifier: "America/New_York")!`
   - Parse Firestore REST response format: `{ "fields": { "joke_id": { "stringValue": "..." } } }`
   - Then fetch the actual joke from `jokes/{joke_id}` collection
   - Parse joke fields: text, character, type (category)
   - Split joke text into setup/punchline using delimiters: "\n\n", " - ", "? ", "! "
   - Return SharedJokeOfTheDay with lastUpdated = Date()

3. Use URLSession.shared.data(from:) with async/await

4. Handle errors gracefully - return nil on any failure (no crashes, no throws)

5. Important: Do NOT import FirebaseFirestore - use only Foundation and URLSession

REST API endpoints:
- daily_jokes: `https://firestore.googleapis.com/v1/projects/mr-funny-jokes/databases/(default)/documents/daily_jokes/{date}`
- jokes: `https://firestore.googleapis.com/v1/projects/mr-funny-jokes/databases/(default)/documents/jokes/{joke_id}`

Note: Firestore REST API allows unauthenticated reads for public collections. If 403 errors occur, security rules may need updating (addressed in verification).
  </action>
  <verify>
Build succeeds: `xcodebuild -workspace MrFunnyJokes.xcworkspace -scheme JokeOfTheDayWidgetExtension -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -20`
File exists with expected structure: `grep -l "firestore.googleapis.com" MrFunnyJokes/JokeOfTheDayWidget/WidgetDataFetcher.swift`
  </verify>
  <done>WidgetDataFetcher.swift exists in widget target, compiles without errors, and contains Firestore REST API endpoints</done>
</task>

<task type="auto">
  <name>Task 2: Add Fallback Jokes Cache to SharedStorageService</name>
  <files>MrFunnyJokes/Shared/SharedStorageService.swift</files>
  <action>
Enhance SharedStorageService.swift with fallback jokes cache functionality:

1. Add new private constants:
   - `private let fallbackJokesKey = "fallbackJokesCache"`
   - `private let maxFallbackJokes = 20`

2. Add method `saveFallbackJokes(_ jokes: [SharedJokeOfTheDay])`:
   - Guard for sharedDefaults
   - Trim array to maxFallbackJokes (20)
   - JSON encode and save to UserDefaults with fallbackJokesKey
   - Handle encoding errors gracefully (print error, don't crash)

3. Add method `getRandomFallbackJoke() -> SharedJokeOfTheDay?`:
   - Guard for sharedDefaults and data existence
   - Decode [SharedJokeOfTheDay] array
   - Return nil if empty or decode fails
   - Return jokes.randomElement()

4. Add method `getFallbackJokeCount() -> Int`:
   - Similar to getCachedJokeCount() pattern
   - Return count of fallback jokes, or 0 if none

Keep existing Siri cache methods unchanged - this is a separate cache for widget fallback.
  </action>
  <verify>
Build succeeds: `xcodebuild -workspace MrFunnyJokes.xcworkspace -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -20`
Methods exist: `grep -E "(saveFallbackJokes|getRandomFallbackJoke|fallbackJokesCache)" MrFunnyJokes/Shared/SharedStorageService.swift`
  </verify>
  <done>SharedStorageService has saveFallbackJokes, getRandomFallbackJoke, and getFallbackJokeCount methods that compile without errors</done>
</task>

<task type="auto">
  <name>Task 3: Update Placeholder Message in SharedJokeOfTheDay</name>
  <files>MrFunnyJokes/Shared/SharedJokeOfTheDay.swift</files>
  <action>
Update the static placeholder in SharedJokeOfTheDay.swift:

Change from:
```swift
static let placeholder = SharedJokeOfTheDay(
    id: "placeholder",
    setup: "Loading jokes...",
    punchline: "Open the app to get today's joke!",
    ...
)
```

To (per CONTEXT.md user decision):
```swift
static let placeholder = SharedJokeOfTheDay(
    id: "placeholder",
    setup: "Open Mr. Funny Jokes to get started!",
    punchline: "",
    category: nil,
    firestoreId: nil,
    character: nil,
    lastUpdated: Date()
)
```

This placeholder is shown ONLY when:
1. JOTD is stale (>24 hours old)
2. Network fetch fails
3. Fallback cache is empty (fresh install, never opened app)

The empty punchline ensures the widget displays cleanly as a single-line message.
  </action>
  <verify>
Build succeeds: `xcodebuild -workspace MrFunnyJokes.xcworkspace -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -20`
Placeholder updated: `grep "Open Mr. Funny Jokes to get started" MrFunnyJokes/Shared/SharedJokeOfTheDay.swift`
  </verify>
  <done>SharedJokeOfTheDay.placeholder shows "Open Mr. Funny Jokes to get started!" with empty punchline</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Widget target builds without errors:
   `xcodebuild -workspace MrFunnyJokes.xcworkspace -scheme JokeOfTheDayWidgetExtension -destination 'platform=iOS Simulator,name=iPhone 16' build`

2. Main app target builds without errors:
   `xcodebuild -workspace MrFunnyJokes.xcworkspace -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 16' build`

3. WidgetDataFetcher.swift exists and uses REST API (not Firebase SDK):
   - Contains: `firestore.googleapis.com`
   - Does NOT contain: `import FirebaseFirestore`

4. SharedStorageService has fallback cache methods:
   - Contains: `fallbackJokesCache`, `saveFallbackJokes`, `getRandomFallbackJoke`

5. SharedJokeOfTheDay has updated placeholder:
   - Contains: `Open Mr. Funny Jokes to get started`
</verification>

<success_criteria>
- WidgetDataFetcher.swift created in widget target with Firestore REST API fetch logic
- SharedStorageService.swift enhanced with fallback jokes cache (save/load/count)
- SharedJokeOfTheDay.swift placeholder updated to user-specified message
- Both targets (app and widget extension) build successfully
- No Firebase SDK imports in widget extension files
</success_criteria>

<output>
After completion, create `.planning/phases/09-widget-background-refresh/09-01-SUMMARY.md`
</output>
