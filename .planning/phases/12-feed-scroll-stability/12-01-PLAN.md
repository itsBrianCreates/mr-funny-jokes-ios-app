---
phase: 12-feed-scroll-stability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - MrFunnyJokes/MrFunnyJokes/Views/JokeFeedView.swift
  - MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift
  - MrFunnyJokes/MrFunnyJokes/Views/CharacterDetailView.swift
  - MrFunnyJokes/MrFunnyJokes/ViewModels/CharacterDetailViewModel.swift
autonomous: false

must_haves:
  truths:
    - "User can scroll upward from the bottom of a long feed without visible jumps or position glitches on iOS 18"
    - "Feed scroll position remains stable when background content loading completes while user is mid-scroll"
    - "Scrolling past conditional content (character carousel, JOTD card, promo card) produces no anchor shifts or stuttering"
  artifacts:
    - path: "MrFunnyJokes/MrFunnyJokes/Views/JokeFeedView.swift"
      provides: "Stable feed scroll with proper item identity and no implicit animations on scroll content"
      contains: "ForEach(feedJokes)"
    - path: "MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift"
      provides: "Background loading that does not trigger scroll-disrupting redraws"
      contains: "withAnimation"
    - path: "MrFunnyJokes/MrFunnyJokes/Views/CharacterDetailView.swift"
      provides: "Character feed with same scroll stability fixes"
    - path: "MrFunnyJokes/MrFunnyJokes/ViewModels/CharacterDetailViewModel.swift"
      provides: "Character detail loading with scoped animations"
      contains: "withAnimation"
  key_links:
    - from: "JokeFeedView.swift"
      to: "JokeViewModel.filteredJokes"
      via: "ForEach using stable Joke.id identity"
      pattern: "ForEach\\(feedJokes\\)"
    - from: "JokeViewModel.swift"
      to: "JokeFeedView.swift"
      via: "isLoadingMore published property with scoped withAnimation"
      pattern: "withAnimation.*isLoadingMore"
---

<objective>
Fix all three scroll stability issues in the joke feed: unstable item identity causing upward scroll jumps, background content loading disrupting scroll position, and conditional content (carousel, JOTD, promo) causing anchor shifts.

Purpose: Users experience smooth, glitch-free scrolling on iOS 18 regardless of what the app is doing in the background.
Output: Updated JokeFeedView.swift, JokeViewModel.swift, CharacterDetailView.swift, and CharacterDetailViewModel.swift with scroll stability fixes.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@MrFunnyJokes/MrFunnyJokes/Views/JokeFeedView.swift
@MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift
@MrFunnyJokes/MrFunnyJokes/Views/CharacterDetailView.swift
@MrFunnyJokes/MrFunnyJokes/ViewModels/CharacterDetailViewModel.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix feed item identity and remove scroll-disrupting animations</name>
  <files>
    MrFunnyJokes/MrFunnyJokes/Views/JokeFeedView.swift
    MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift
    MrFunnyJokes/MrFunnyJokes/Views/CharacterDetailView.swift
    MrFunnyJokes/MrFunnyJokes/ViewModels/CharacterDetailViewModel.swift
  </files>
  <action>
  Fix three scroll stability problems across JokeFeedView, JokeViewModel, CharacterDetailView, and CharacterDetailViewModel:

  **Fix 1: Remove unstable ForEach enumeration pattern (SCROLL-01)**

  In JokeFeedView.swift, the current ForEach on line 93 uses:
  ```swift
  ForEach(Array(feedJokes.enumerated()), id: \.element.id) { index, joke in
  ```

  The `enumerated()` wrapper is used solely to check `index == youtubePromoPosition` for inserting the YouTube promo card at position 4 inside the joke list. This causes the promo card to be inserted/removed dynamically within the ForEach based on array index, which destabilizes scroll anchors because SwiftUI sees the promo card appearing between joke items and must re-layout.

  Changes to JokeFeedView.swift:
  - Replace `ForEach(Array(feedJokes.enumerated()), id: \.element.id) { index, joke in` with `ForEach(feedJokes) { joke in`
  - Remove the `if showYouTubePromo && index == youtubePromoPosition { ... }` block from inside the ForEach (the one that checks `index == youtubePromoPosition`)
  - Remove the second YouTube promo fallback block (the one that checks `feedJokes.count <= youtubePromoPosition`)
  - Add the YouTube promo card as a standalone item in the LazyVStack, placed between the Monthly Top 10 carousel and the ForEach. It should look like:
    ```swift
    // Monthly Top 10 carousel (only when "All" is selected)
    if showMonthlyTopTen {
        MonthlyTopTenCarouselView(...)
    }

    // YouTube promo card (only when "All" is selected and not dismissed)
    if showYouTubePromo {
        YouTubePromoCardView(onDismiss: {
            withAnimation(.easeInOut(duration: 0.3)) {
                youtubePromoDismissed = true
            }
        })
        .transition(.asymmetric(
            insertion: .opacity,
            removal: .opacity.combined(with: .scale(scale: 0.95))
        ))
    }

    // Regular joke feed
    ForEach(feedJokes) { joke in
        JokeCardView(...)
    }
    ```
  - Remove the `youtubePromoPosition` constant since it is no longer used

  **Fix 2: Remove implicit .animation() modifiers from scroll containers (SCROLL-02)**

  In JokeFeedView.swift, lines 168-169 have implicit animation modifiers applied to the ScrollView:
  ```swift
  .animation(.easeInOut(duration: 0.3), value: viewModel.isOffline)
  .animation(.easeInOut(duration: 0.3), value: viewModel.isLoadingMore)
  ```

  These cause SwiftUI to animate ALL layout changes in the entire ScrollView whenever `isOffline` or `isLoadingMore` changes. When background content finishes loading and `isLoadingMore` flips to false, the new joke items get animated in, causing visible scroll jumps.

  Changes to JokeFeedView.swift:
  - Remove both `.animation(...)` modifiers from the ScrollView (lines 168-169)

  Changes to JokeViewModel.swift:
  - Add `import SwiftUI` if not already present (it is -- line 1)
  - In `performLoadMore()`, change `isLoadingMore = true` to `withAnimation(.easeInOut(duration: 0.3)) { self.isLoadingMore = true }`
  - In `performLoadMore()`, change `isLoadingMore = false` (the final one near the end of the method) to `withAnimation(.easeInOut(duration: 0.3)) { self.isLoadingMore = false }`
  - IMPORTANT: The guard clause `isLoadingMore = false; return` for task cancellation should NOT be animated (just set directly), only the normal flow start and end
  - In `init()`, in the networkMonitor sink closure, change `self?.isOffline = !isConnected` to:
    ```swift
    withAnimation(.easeInOut(duration: 0.3)) {
        self?.isOffline = !isConnected
    }
    ```

  **Fix 3: Apply same animation fix to CharacterDetailView (SCROLL-02 for character feeds)**

  In CharacterDetailView.swift, the `jokesList` computed property (line 190) has:
  ```swift
  .animation(.easeInOut(duration: 0.3), value: viewModel.isLoadingMore)
  ```

  Changes to CharacterDetailView.swift:
  - Remove the `.animation(.easeInOut(duration: 0.3), value: viewModel.isLoadingMore)` modifier from `jokesList`

  Changes to CharacterDetailViewModel.swift:
  - Add `import SwiftUI` at the top (currently only imports SwiftUI indirectly -- check and add if needed)
  - In `loadMoreJokes()`, change `isLoadingMore = true` to `withAnimation(.easeInOut(duration: 0.3)) { self.isLoadingMore = true }`
  - In `loadMoreJokes()`, change the final `isLoadingMore = false` to `withAnimation(.easeInOut(duration: 0.3)) { self.isLoadingMore = false }`

  **What NOT to change:**
  - Do NOT change the `.refreshable` behavior
  - Do NOT change the `.onChange(of: viewModel.selectedCategory)` scroll-to-top behavior
  - Do NOT change the `feedJokes` computed property logic
  - Do NOT change the `filteredJokes` computed property in either ViewModel
  - Do NOT change the `.transition()` modifiers on individual views (those are fine)
  </action>
  <verify>
  Build the project with `xcodebuild build -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 16' -quiet` and confirm zero errors. Then verify via grep:
  1. JokeFeedView.swift does NOT contain `enumerated()` in the ForEach
  2. JokeFeedView.swift does NOT contain `.animation(` on the ScrollView
  3. JokeFeedView.swift has YouTubePromoCardView placed as standalone LazyVStack item (not inside ForEach)
  4. CharacterDetailView.swift does NOT contain `.animation(` on jokesList
  5. JokeViewModel.swift contains `withAnimation` near `isLoadingMore` assignments
  6. CharacterDetailViewModel.swift contains `withAnimation` near `isLoadingMore` assignments
  </verify>
  <done>
  JokeFeedView uses stable `ForEach(feedJokes)` identity without enumerated(), YouTube promo card is a standalone LazyVStack item outside the ForEach, no implicit `.animation()` modifiers exist on scroll containers in either JokeFeedView or CharacterDetailView, and loading indicator animations are explicitly scoped via `withAnimation` in both JokeViewModel and CharacterDetailViewModel.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify scroll stability on device or simulator</name>
  <files>
    MrFunnyJokes/MrFunnyJokes/Views/JokeFeedView.swift
    MrFunnyJokes/MrFunnyJokes/Views/CharacterDetailView.swift
  </files>
  <action>
  Human verification of scroll stability after automated fixes. No code changes needed -- this is a visual/functional verification checkpoint.
  </action>
  <verify>
  Run the app on iOS 18 simulator (iPhone 16) or a physical device and perform the following tests:

  1. **SCROLL-01 test (upward scroll jumps):**
     - Open the app, wait for jokes to load
     - Scroll down through at least 20-30 jokes
     - Scroll back up quickly
     - Expected: No visible jumps, stuttering, or position glitches while scrolling upward

  2. **SCROLL-02 test (background loading stability):**
     - Open the app fresh (force quit first)
     - As soon as jokes appear, start scrolling slowly downward
     - Background loading will trigger on first scroll and load the full catalog
     - Expected: Scroll position does not jump or shift as new jokes are loaded in the background
     - Also verify: When the loading skeleton appears at the bottom and disappears, scroll position remains stable

  3. **SCROLL-03 test (conditional content stability):**
     - Open the app on "All" tab (shows carousel, JOTD, promo card if not dismissed)
     - Scroll past the character carousel, JOTD card, and promo card into the joke list
     - Expected: No stuttering or anchor shifts when scrolling past these sections
     - If YouTube promo is visible, tap dismiss (X button) and verify the feed does not jump
     - Switch to a category filter (e.g., "Dad Jokes") and back to "All" -- verify smooth transitions

  4. **Character detail scroll test:**
     - Navigate to any character (e.g., Mr. Funny)
     - Scroll through their jokes
     - Expected: No scroll jumps when loading more jokes
  </verify>
  <done>
  All four scroll stability tests pass with no visible jumps, stuttering, or position glitches. SCROLL-01, SCROLL-02, and SCROLL-03 requirements verified by human tester.
  </done>
</task>

</tasks>

<verification>
- `xcodebuild build` succeeds with no errors
- No `.animation()` modifiers exist on ScrollView or its direct children in JokeFeedView
- No `enumerated()` usage in ForEach within JokeFeedView
- YouTube promo card is placed outside the ForEach loop as a standalone LazyVStack item
- `withAnimation` is used for scoped `isLoadingMore` transitions in both ViewModels
- `withAnimation` is used for scoped `isOffline` transitions in JokeViewModel
- Manual scroll testing confirms smooth behavior per SCROLL-01, SCROLL-02, SCROLL-03
</verification>

<success_criteria>
1. User can scroll upward from the bottom of a long feed without visible jumps or position glitches on iOS 18
2. Feed scroll position remains stable when background content loading completes while user is mid-scroll
3. Scrolling past conditional content (character carousel, JOTD card, promo card) produces no anchor shifts or stuttering
4. Project builds with zero errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-feed-scroll-stability/12-01-SUMMARY.md`
</output>
