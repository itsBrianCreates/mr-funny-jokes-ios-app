---
phase: 13-data-migration-cloud-function
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/migrate-rating-events.js
  - scripts/package.json
  - functions/index.js
autonomous: true

must_haves:
  truths:
    - "Firestore migration script remaps rating 4->5, 2->1, and deletes rating 3 documents from rating_events"
    - "Firestore migration script supports --dry-run mode that logs changes without writing"
    - "Cloud Function aggregates ALL rating_events (no week_id filter) and writes to weekly_rankings/all_time document"
    - "Feature branch v1.1.0 exists and all commits land on it"
  artifacts:
    - path: "scripts/migrate-rating-events.js"
      provides: "One-time Firestore rating_events migration to binary format"
      contains: "migrateRating"
    - path: "functions/index.js"
      provides: "All-time aggregation Cloud Function"
      contains: "all_time"
  key_links:
    - from: "scripts/migrate-rating-events.js"
      to: "Firestore rating_events collection"
      via: "firebase-admin batch update/delete"
      pattern: "rating_events"
    - from: "functions/index.js"
      to: "Firestore weekly_rankings/all_time"
      via: "db.collection(WEEKLY_RANKINGS_COLLECTION).doc(\"all_time\")"
      pattern: "all_time"
---

<objective>
Create the v1.1.0 feature branch, build a Firestore migration script to convert rating_events from 5-point to binary format, and update the Cloud Function to aggregate all-time rankings instead of weekly ones.

Purpose: Backend data must be binary-compatible and all-time rankings must be producible before any client-side changes in later phases.
Output: Feature branch, runnable migration script, updated Cloud Function ready to deploy.
</objective>

<execution_context>
@/Users/brianvanaski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brianvanaski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-data-migration-cloud-function/13-RESEARCH.md

@scripts/migrate-holiday-tags.js
@scripts/package.json
@functions/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create feature branch and Firestore migration script</name>
  <files>scripts/migrate-rating-events.js, scripts/package.json</files>
  <action>
1. Create git branch `v1.1.0` from `main`: `git checkout -b v1.1.0`

2. Create `scripts/migrate-rating-events.js` following the EXACT pattern from `scripts/migrate-holiday-tags.js`:
   - ES module syntax (import statements)
   - Firebase Admin SDK initialized from `serviceAccountKey.json` (same `initializeFirebase()` pattern)
   - `--dry-run` flag via `process.argv`
   - Logging with `[INFO]`, `[WARN]`, `[ERROR]`, `[SUCCESS]` prefixes and timestamps (same `log` object)
   - `BATCH_SIZE = 500`

3. Migration logic for `rating_events` collection:
   - Fetch ALL documents from `rating_events` collection
   - For each document, read the `rating` field (integer)
   - Migration rules:
     - Rating 4 or 5 -> update to 5 (Hilarious)
     - Rating 1 or 2 -> update to 1 (Horrible)
     - Rating 3 -> DELETE the document entirely
     - Rating already 1 or 5 -> skip (no change needed)
   - Use `batch.update(docRef, { rating: newRating })` for remapping (NOT `set()` -- must preserve all other fields)
   - Use `batch.delete(docRef)` for rating 3 documents
   - Process in batches of 500 (Firestore batch limit)

4. Summary report at the end:
   - Total documents processed
   - Remapped to Hilarious (count)
   - Remapped to Horrible (count)
   - Deleted (rating 3 count)
   - Already binary (skipped count)
   - If dry-run, note "no changes written"

5. Add npm scripts to `scripts/package.json`:
   - `"migrate-ratings": "node migrate-rating-events.js"`
   - `"migrate-ratings:dry-run": "node migrate-rating-events.js --dry-run"`
  </action>
  <verify>
- File exists: `scripts/migrate-rating-events.js`
- `scripts/package.json` has `migrate-ratings` and `migrate-ratings:dry-run` scripts
- Script imports match the pattern from `migrate-holiday-tags.js` (ES module syntax)
- Script handles all 3 migration cases: remap 4/5->5, remap 1/2->1, delete 3
- Script uses `batch.update()` not `batch.set()` for remapping
- Script uses `batch.delete()` for rating 3 documents
- `git branch` shows `v1.1.0` as current branch
  </verify>
  <done>Feature branch v1.1.0 exists. Migration script is ready to run with --dry-run first, then live. Script follows established codebase patterns exactly.</done>
</task>

<task type="auto">
  <name>Task 2: Update Cloud Function for all-time aggregation</name>
  <files>functions/index.js</files>
  <action>
Modify `functions/index.js` to aggregate ALL rating events into an all-time document instead of weekly:

1. Add a new function `fetchAllRatingEvents()` that queries the entire `rating_events` collection WITHOUT any `where("week_id", ...)` filter:
   ```javascript
   async function fetchAllRatingEvents() {
     const snapshot = await db.collection(RATING_EVENTS_COLLECTION).get();
     return snapshot.docs.map(doc => doc.data());
   }
   ```

2. Add a new function `saveAllTimeRankings(rankings)` that writes to a fixed `all_time` document ID:
   ```javascript
   async function saveAllTimeRankings(rankings) {
     const document = {
       week_id: "all_time",
       hilarious: rankings.hilarious,
       horrible: rankings.horrible,
       total_hilarious_ratings: rankings.totalHilarious,
       total_horrible_ratings: rankings.totalHorrible,
       computed_at: FieldValue.serverTimestamp()
     };
     await db.collection(WEEKLY_RANKINGS_COLLECTION).doc("all_time").set(document);
   }
   ```
   Note: No `week_start` or `week_end` fields needed for all-time document.

3. Modify `runAggregation()`:
   - Change to always run all-time aggregation (ignore weekId parameter)
   - Call `fetchAllRatingEvents()` instead of `fetchRatingEvents(weekId)`
   - Call `saveAllTimeRankings(...)` instead of `saveWeeklyRankings(weekId, ...)`
   - Update logger messages to say "all-time" instead of week references
   - Return object should use `documentId: "all_time"` instead of `weekId`

4. Keep unchanged:
   - `aggregateRatings()` function (already handles binary correctly: 4-5=hilarious, 1-2=horrible, 3=ignored)
   - `rankTopN()` function
   - The `aggregateRankings` scheduled function export (still daily midnight ET)
   - The `triggerAggregation` HTTP function export (remove the `weekId` query param since it is no longer relevant)
   - `getCurrentWeekId()` and `getWeekDateRange()` can remain as dead code (harmless, keeps diff small)

5. Update the file header comment to reflect all-time aggregation instead of weekly.
  </action>
  <verify>
- `functions/index.js` contains `fetchAllRatingEvents()` function without week_id filter
- `functions/index.js` contains `saveAllTimeRankings()` writing to `doc("all_time")`
- `runAggregation()` calls `fetchAllRatingEvents()` and `saveAllTimeRankings()`
- `aggregateRatings()` function is unchanged
- `rankTopN()` function is unchanged
- Scheduled and HTTP exports still exist
- No syntax errors (verify with: `cd functions && node -c index.js`)
  </verify>
  <done>Cloud Function aggregates ALL rating events (no time window) and writes to weekly_rankings/all_time document. Ready for deployment with `firebase deploy --only functions`.</done>
</task>

</tasks>

<verification>
1. `git branch` shows `v1.1.0` as current branch
2. `scripts/migrate-rating-events.js` exists and follows established migration script pattern
3. `scripts/package.json` has `migrate-ratings` and `migrate-ratings:dry-run` scripts
4. `functions/index.js` has `fetchAllRatingEvents()` without week_id filter
5. `functions/index.js` writes to `doc("all_time")` instead of `doc(weekId)`
6. `cd functions && node -c index.js` succeeds (no syntax errors)
</verification>

<success_criteria>
- Feature branch `v1.1.0` is the active branch with all commits
- Migration script is ready to execute: `cd scripts && npm run migrate-ratings:dry-run` then `npm run migrate-ratings`
- Cloud Function produces all-time rankings document: `cd functions && firebase deploy --only functions` (user runs when ready)
- No weekly filtering remains in the aggregation path
</success_criteria>

<output>
After completion, create `.planning/phases/13-data-migration-cloud-function/13-01-SUMMARY.md`
</output>
