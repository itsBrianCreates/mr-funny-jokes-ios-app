---
phase: 13-data-migration-cloud-function
plan: 02
type: execute
wave: 2
depends_on: ["13-01"]
files_modified:
  - MrFunnyJokes/MrFunnyJokes/Services/LocalStorageService.swift
  - MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift
autonomous: true

must_haves:
  truths:
    - "User who previously rated jokes with 1-5 scale sees ratings preserved after app update (4-5 become 5, 1-2 become 1, 3s removed)"
    - "Migration runs exactly once per device (idempotent via UserDefaults flag)"
    - "Migration runs before any rating data is read or displayed"
  artifacts:
    - path: "MrFunnyJokes/MrFunnyJokes/Services/LocalStorageService.swift"
      provides: "migrateRatingsToBinaryIfNeeded() method"
      contains: "hasMigratedRatingsToBinary"
    - path: "MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift"
      provides: "Migration trigger at app launch"
      contains: "migrateRatingsToBinaryIfNeeded"
  key_links:
    - from: "MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift"
      to: "LocalStorageService.migrateRatingsToBinaryIfNeeded()"
      via: "Called before preloadMemoryCacheAsync in loadInitialContentAsync"
      pattern: "migrateRatingsToBinaryIfNeeded"
---

<objective>
Add a one-time local rating migration to the iOS app that converts existing 5-point ratings stored in UserDefaults to binary format (Hilarious=5, Horrible=1) at app launch.

Purpose: Existing user ratings must be preserved in the new binary format before any rating UI or data is shown.
Output: LocalStorageService migration method wired into app launch sequence.
</objective>

<execution_context>
@/Users/brianvanaski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brianvanaski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/13-data-migration-cloud-function/13-RESEARCH.md

@MrFunnyJokes/MrFunnyJokes/Services/LocalStorageService.swift
@MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add binary rating migration to LocalStorageService and wire into app launch</name>
  <files>MrFunnyJokes/MrFunnyJokes/Services/LocalStorageService.swift, MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift</files>
  <action>
**Part A: LocalStorageService.swift**

Add a new MARK section `// MARK: - Rating Migration (v1.1.0)` after the existing `// MARK: - Ratings` section (but before the legacy rating methods). Add the following method:

1. Private constant: `private let binaryMigrationKey = "hasMigratedRatingsToBinary"`

2. Method `migrateRatingsToBinaryIfNeeded()`:
   - Guard: check `!userDefaults.bool(forKey: binaryMigrationKey)`, return early if already migrated
   - Run on `queue.sync` for thread safety (same pattern as other rating methods)
   - Load ratings via `self.loadRatingsSync()` -> `[String: Int]`
   - Load timestamps via `self.loadRatingTimestampsSync()` -> `[String: TimeInterval]`
   - Track `var changed = false` and `var keysToRemove: [String] = []`
   - Iterate over ratings dictionary:
     - Rating 4 or 5 -> set to 5 (Hilarious), mark changed
     - Rating 1 or 2 -> set to 1 (Horrible), mark changed
     - Rating 3 -> append key to `keysToRemove`, mark changed
     - Any other value (already 1 or 5, or unexpected) -> skip
   - Remove keys from both `ratings` and `timestamps` dictionaries for rating-3 entries
   - If `changed`: save ratings via `self.saveRatingsSync(ratings)` and timestamps via `self.saveRatingTimestampsSync(timestamps)`
   - Set migration flag: `userDefaults.set(true, forKey: binaryMigrationKey)` -- set AFTER successful completion
   - Print migration summary: number remapped, number dropped

**Part B: JokeViewModel.swift**

In `loadInitialContentAsync()`, add a call to `storage.migrateRatingsToBinaryIfNeeded()` as the VERY FIRST line, BEFORE `await storage.preloadMemoryCacheAsync()` (PHASE 1). This ensures:
- Migration happens before any rating data is read
- The memory cache loads already-migrated data
- No stale 2/3/4 values are ever shown to the user

The call is synchronous (runs on LocalStorageService's dispatch queue) so it completes before the async cache preload begins. This is correct because:
- It runs once ever (gated by UserDefaults flag)
- On subsequent launches, the guard clause returns immediately (negligible cost)
  </action>
  <verify>
- `LocalStorageService.swift` contains `migrateRatingsToBinaryIfNeeded()` method
- Method contains `binaryMigrationKey` / `hasMigratedRatingsToBinary` guard
- Method handles all 3 cases: 4/5->5, 1/2->1, 3->remove
- Method removes timestamps for dropped rating-3 entries
- Method sets migration flag AFTER completion (not before)
- Method uses `queue.sync` for thread safety
- `JokeViewModel.swift` calls `storage.migrateRatingsToBinaryIfNeeded()` before `preloadMemoryCacheAsync()`
- Xcode build succeeds: `xcodebuild -project MrFunnyJokes/MrFunnyJokes.xcodeproj -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5`
  </verify>
  <done>Local ratings are migrated from 5-point to binary on first app launch after update. Migration is idempotent (runs once), runs before any data display, and preserves timestamps for non-dropped ratings. Build succeeds.</done>
</task>

</tasks>

<verification>
1. `LocalStorageService.swift` has `migrateRatingsToBinaryIfNeeded()` with correct migration rules
2. `JokeViewModel.swift` calls migration before memory cache preload
3. Migration flag prevents re-execution on subsequent launches
4. Timestamps for rating-3 entries are cleaned up
5. Xcode build succeeds
</verification>

<success_criteria>
- A user with existing ratings {1,2,3,4,5} will see them become {1,1,removed,5,5} after the app update
- Migration runs exactly once (gated by `hasMigratedRatingsToBinary` flag)
- Migration runs before any UI reads rating data (before memory cache preload)
- No compile errors
</success_criteria>

<output>
After completion, create `.planning/phases/13-data-migration-cloud-function/13-02-SUMMARY.md`
</output>
