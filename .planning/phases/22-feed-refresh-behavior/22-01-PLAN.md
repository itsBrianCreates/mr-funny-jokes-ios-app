---
phase: 22-feed-refresh-behavior
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift
  - MrFunnyJokes/MrFunnyJokes/Views/JokeFeedView.swift
autonomous: true

must_haves:
  truths:
    - "After rating a joke and pulling to refresh, rated jokes appear at the bottom of the feed and unrated jokes appear at the top"
    - "After closing and reopening the app, previously rated jokes remain at the bottom of the feed"
    - "After pull-to-refresh completes, the feed scrolls back to the very top showing the first unrated joke"
  artifacts:
    - path: "MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift"
      provides: "filteredJokes that keeps rated jokes at bottom instead of hiding them"
      contains: "rated jokes at the bottom"
    - path: "MrFunnyJokes/MrFunnyJokes/Views/JokeFeedView.swift"
      provides: "Reliable scroll-to-top after pull-to-refresh"
      contains: "proxy.scrollTo"
  key_links:
    - from: "JokeViewModel.filteredJokes"
      to: "JokeViewModel.sortJokesForFreshFeed"
      via: "Rated jokes included in computed property, sorted to bottom by freshness sort"
      pattern: "unrated.*rated"
    - from: "JokeFeedView.refreshable"
      to: "ScrollViewReader.proxy.scrollTo"
      via: "Scroll to top after refresh completes"
      pattern: "proxy\\.scrollTo.*topAnchorID"
---

<objective>
Fix pull-to-refresh to reorder rated jokes to the bottom of the feed instead of hiding them, persist this ordering across app sessions, and ensure the feed scrolls to the top after refresh.

Purpose: Users who rate jokes and pull to refresh expect rated jokes to move to the bottom (not vanish). This ordering should survive app close/reopen. The feed should also reliably scroll to the top after refreshing.

Output: Modified JokeViewModel.filteredJokes and JokeViewModel.refresh() to keep rated jokes visible at the bottom, plus verified scroll-to-top behavior in JokeFeedView.
</objective>

<execution_context>
@/Users/brianvanaski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brianvanaski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift
@MrFunnyJokes/MrFunnyJokes/Views/JokeFeedView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix filteredJokes to keep rated jokes at bottom instead of hiding them</name>
  <files>MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift</files>
  <action>
The root cause is in `filteredJokes` (line 56-90). Currently it EXCLUDES rated jokes (except session-rated ones via `sessionRatedJokeIds`). After pull-to-refresh clears `sessionRatedJokeIds`, all rated jokes vanish from the feed. The fix:

1. **Change `filteredJokes` computed property** to include ALL jokes (both rated and unrated), but ensure rated jokes appear at the bottom:

   Replace the current Step 2 logic (lines 67-75) that filters to unrated-only. Instead:
   - Separate jokes into two groups: unrated jokes and rated jokes
   - Unrated jokes stay sorted by `popularityScore` descending (existing Step 3 logic)
   - Rated jokes go after all unrated jokes, also sorted by `popularityScore` descending
   - The seasonal demotion (Step 4) still applies to the final combined array

   The new `filteredJokes` should look like:
   ```swift
   var filteredJokes: [Joke] {
       // Step 1: Apply category filter if selected
       let categoryFiltered: [Joke]
       if let category = selectedCategory {
           categoryFiltered = jokes.filter { $0.category == category }
       } else {
           categoryFiltered = jokes
       }

       // Step 2: Separate into unrated and rated groups
       // Unrated jokes appear first, rated jokes appear at the bottom
       let unrated = categoryFiltered.filter { $0.userRating == nil }
       let rated = categoryFiltered.filter { $0.userRating != nil }

       // Step 3: Sort each group by popularity score (descending)
       let sortedUnrated = unrated.sorted { $0.popularityScore > $1.popularityScore }
       let sortedRated = rated.sorted { $0.popularityScore > $1.popularityScore }

       // Step 4: Combine with unrated first, rated at bottom
       let combined = sortedUnrated + sortedRated

       // Step 5: Apply seasonal demotion for Christmas jokes outside Nov 1 - Dec 31
       if !SeasonalHelper.isChristmasSeason() {
           let nonChristmas = combined.filter { !$0.isChristmasJoke }
           let christmas = combined.filter { $0.isChristmasJoke }
           return nonChristmas + christmas
       } else {
           return combined
       }
   }
   ```

2. **Remove `sessionRatedJokeIds`** — This tracking mechanism was only needed because rated jokes were being hidden. Since rated jokes now stay visible (at the bottom), session tracking is unnecessary. Remove:
   - The `sessionRatedJokeIds` property declaration (line 38)
   - The `sessionRatedJokeIds.removeAll()` call in `refresh()` (line 579)
   - The `sessionRatedJokeIds.insert(key)` call in `rateJoke()` (line 841)

3. **Why this fixes FEED-02 (persistence across sessions):** The ordering is based on `userRating` which comes from `LocalStorageService` (persisted in UserDefaults). When the app restarts and jokes reload, `storage.getRating()` is called on each joke (see lines 337, 480-483, 539-541, 627-629, 778-779, 700-701). Jokes with ratings get `userRating != nil`, so they sort to the bottom of `filteredJokes` automatically. No additional persistence work needed.

Important: Do NOT use `.animation()` on scroll containers per CLAUDE.md. The `withAnimation` pattern at mutation sites in the ViewModel is already correct.
  </action>
  <verify>
Build the project with `xcodebuild build -project MrFunnyJokes/MrFunnyJokes.xcodeproj -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 16' -quiet 2>&1 | tail -5` to confirm no compile errors. Verify `sessionRatedJokeIds` no longer exists in the file with a grep.
  </verify>
  <done>
filteredJokes includes all jokes with rated jokes sorted to the bottom. sessionRatedJokeIds tracking removed. Build succeeds with no errors. Ordering persists across sessions because it derives from LocalStorageService ratings stored in UserDefaults.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify and harden scroll-to-top after pull-to-refresh</name>
  <files>MrFunnyJokes/MrFunnyJokes/Views/JokeFeedView.swift</files>
  <action>
The scroll-to-top after refresh is already implemented in JokeFeedView (lines 137-145) using `proxy.scrollTo(topAnchorID, anchor: .top)` with a 100ms delay. Review and verify this works correctly with the new filteredJokes behavior.

Current implementation:
```swift
.refreshable {
    await viewModel.refresh()
    try? await Task.sleep(for: .milliseconds(100))
    withAnimation(.easeOut(duration: 0.2)) {
        proxy.scrollTo(topAnchorID, anchor: .top)
    }
}
```

This should work correctly because:
- The `topAnchorID` anchor is a `Color.clear.frame(height: 0).id(topAnchorID)` at the very top of the LazyVStack
- The 100ms delay allows the SwiftUI refresh animation to complete before scrolling
- `withAnimation` provides smooth scroll

Verify the implementation is correct and the topAnchorID is the first item in the LazyVStack. If the 100ms delay proves unreliable (scroll doesn't reach top), increase to 200ms. Otherwise, no changes needed — just confirm FEED-03 is satisfied by the existing implementation.

Note: Do NOT add `.animation()` modifiers to the ScrollView or LazyVStack per CLAUDE.md bug prevention patterns.
  </action>
  <verify>
Build succeeds. Read JokeFeedView.swift and confirm: (1) topAnchorID anchor is the first item in the LazyVStack, (2) .refreshable calls viewModel.refresh() then scrolls to topAnchorID, (3) no .animation() modifiers on scroll containers.
  </verify>
  <done>
Pull-to-refresh scrolls to top after completing. The topAnchorID anchor is first in the LazyVStack. No scroll-disrupting .animation() modifiers present.
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. Build succeeds: `xcodebuild build -project MrFunnyJokes/MrFunnyJokes.xcodeproj -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 16' -quiet`
2. `grep -n "sessionRatedJokeIds" MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift` returns no results (session tracking removed)
3. `grep -n "userRating == nil" MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift` confirms rated/unrated split in filteredJokes
4. `grep -n "proxy.scrollTo" MrFunnyJokes/MrFunnyJokes/Views/JokeFeedView.swift` confirms scroll-to-top in refreshable
5. No `.animation()` on ScrollView or LazyVStack in JokeFeedView.swift
</verification>

<success_criteria>
- FEED-01: filteredJokes shows unrated jokes first, rated jokes at the bottom (not hidden)
- FEED-02: Ordering persists across app close/reopen because it derives from LocalStorageService UserDefaults ratings
- FEED-03: Pull-to-refresh scrolls feed to top via ScrollViewReader proxy
- Build compiles with no errors
- No regressions to seasonal demotion, category filtering, or infinite scroll
</success_criteria>

<output>
After completion, create `.planning/phases/22-feed-refresh-behavior/22-01-SUMMARY.md`
</output>
