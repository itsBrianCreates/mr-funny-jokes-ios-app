---
phase: 22-feed-refresh-behavior
plan: 02
type: execute
wave: 1
depends_on: ["22-01"]
files_modified:
  - "MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift"
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "After rating a joke, it stays in its current position in the feed until pull-to-refresh or app restart"
    - "After pull-to-refresh, session-rated jokes move to the bottom of the feed"
    - "After app restart (fresh ViewModel init), previously-rated jokes appear at bottom via persisted ratings"
  artifacts:
    - path: "MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift"
      provides: "sessionRatedJokeIds tracking + deferred reorder in filteredJokes"
      contains: "sessionRatedJokeIds"
  key_links:
    - from: "rateJoke()"
      to: "sessionRatedJokeIds"
      via: "Insert joke ID into set on rating"
      pattern: "sessionRatedJokeIds\\.insert"
    - from: "filteredJokes"
      to: "sessionRatedJokeIds"
      via: "Treat session-rated jokes as unrated for sorting"
      pattern: "sessionRatedJokeIds\\.contains"
    - from: "refresh()"
      to: "sessionRatedJokeIds"
      via: "Clear set on pull-to-refresh so rated jokes reorder to bottom"
      pattern: "sessionRatedJokeIds\\.removeAll\\(\\)|sessionRatedJokeIds = \\[\\]"
---

<objective>
Fix rated joke immediate reorder: jokes rated during the current session should stay in place until pull-to-refresh or app restart.

Purpose: User reported that rating a joke causes it to jump to the bottom of the feed immediately. The user wants to be able to rate a joke and still find it in the same position to share it. Reordering should only happen on pull-to-refresh or app restart.

Output: Updated JokeViewModel.swift with sessionRatedJokeIds tracking that defers sort reordering.
</objective>

<execution_context>
@/Users/brianvanaski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brianvanaski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22-feed-refresh-behavior/22-01-SUMMARY.md
@MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add sessionRatedJokeIds and defer sort reorder for session-rated jokes</name>
  <files>MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift</files>
  <action>
Add a private Set property to track jokes rated during the current session:

```swift
/// Jokes rated during this session — treated as unrated for sort order
/// so they don't jump to the bottom immediately. Cleared on pull-to-refresh.
private var sessionRatedJokeIds: Set<String> = []
```

Place this near the other private properties (around line 46, near `cancellables`).

In `rateJoke(_ joke: Joke, rating: Int)` (line 807):
- When a non-zero rating is applied (inside the `else` branch at line 828), after `jokes[index].userRating = clampedRating` (line 835), add:
  ```swift
  let sessionKey = joke.firestoreId ?? joke.id.uuidString
  sessionRatedJokeIds.insert(sessionKey)
  ```
- Also handle the `else` branch where joke is appended (line 839-841): add the same sessionRatedJokeIds insert after the append.
- When rating is removed (rating == 0, line 822-826): remove from sessionRatedJokeIds too:
  ```swift
  let sessionKey = joke.firestoreId ?? joke.id.uuidString
  sessionRatedJokeIds.remove(sessionKey)
  ```

In `filteredJokes` computed property (line 53-83):
- Change the unrated/rated separation (Step 2, lines 64-65) to treat session-rated jokes as unrated for sorting purposes:
  ```swift
  // Step 2: Separate into unrated and rated groups
  // Session-rated jokes stay in the unrated group so they don't jump positions
  // They'll move to the rated group after pull-to-refresh clears sessionRatedJokeIds
  let unrated = categoryFiltered.filter { joke in
      joke.userRating == nil || sessionRatedJokeIds.contains(joke.firestoreId ?? joke.id.uuidString)
  }
  let rated = categoryFiltered.filter { joke in
      joke.userRating != nil && !sessionRatedJokeIds.contains(joke.firestoreId ?? joke.id.uuidString)
  }
  ```

In `refresh()` (line 565):
- After `isRefreshing = true` (line 572), add:
  ```swift
  sessionRatedJokeIds.removeAll()
  ```
  This ensures that after pull-to-refresh, all rated jokes (including ones rated this session) get reordered to the bottom.

Note: On app restart, sessionRatedJokeIds starts empty (it's not persisted), so previously-rated jokes will correctly appear at the bottom via the existing persisted userRating logic. This is the desired behavior.

Do NOT touch CharacterDetailViewModel — it does not have unrated/rated separation and is not affected by this gap.
  </action>
  <verify>
Build the project with Xcode:
```bash
cd /Users/brianvanaski/conductor/workspaces/mr-funny-jokes-ios-app/tyler && xcodebuild -project MrFunnyJokes/MrFunnyJokes.xcodeproj -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 16' build 2>&1 | tail -5
```
Verify:
1. `sessionRatedJokeIds` property exists
2. `rateJoke()` inserts into sessionRatedJokeIds on rating
3. `filteredJokes` checks sessionRatedJokeIds to keep session-rated jokes in the unrated group
4. `refresh()` clears sessionRatedJokeIds
5. Build succeeds with no errors
  </verify>
  <done>
- sessionRatedJokeIds property added as private Set<String>
- rateJoke() inserts joke ID into sessionRatedJokeIds when rating is applied, removes when rating is cleared
- filteredJokes treats session-rated jokes as unrated for sorting (they stay in place)
- refresh() clears sessionRatedJokeIds so rated jokes move to bottom after pull-to-refresh
- App restart naturally clears sessionRatedJokeIds (not persisted) so rated jokes appear at bottom
- Build succeeds
  </done>
</task>

</tasks>

<verification>
1. Build succeeds: `xcodebuild build` completes without errors
2. Code review: `filteredJokes` uses `sessionRatedJokeIds.contains()` to defer reorder
3. Code review: `rateJoke()` populates `sessionRatedJokeIds` on rating
4. Code review: `refresh()` calls `sessionRatedJokeIds.removeAll()`
5. Code review: `sessionRatedJokeIds` is NOT persisted (private var, starts empty)
</verification>

<success_criteria>
- Rating a joke does NOT cause it to jump to the bottom of the feed during the current session
- Pull-to-refresh clears sessionRatedJokeIds, causing rated jokes to reorder to the bottom
- App restart starts with empty sessionRatedJokeIds, so previously-rated jokes appear at bottom via persisted userRating
- No regressions: existing feed behavior (category filtering, seasonal demotion, infinite scroll) unchanged
</success_criteria>

<output>
After completion, create `.planning/phases/22-feed-refresh-behavior/22-02-SUMMARY.md`
</output>
