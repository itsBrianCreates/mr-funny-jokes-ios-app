---
phase: 03-siri-integration
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift
  - MrFunnyJokes/MrFunnyJokes/Views/SettingsView.swift
autonomous: false

must_haves:
  truths:
    - "Jokes are cached for Siri when main app fetches them"
    - "User can discover Siri command from Settings screen"
    - "Siri speaks joke aloud on physical device"
    - "App Shortcut appears in Shortcuts app"
  artifacts:
    - path: "MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift"
      provides: "Siri cache population on joke fetch"
      contains: "saveCachedJokesForSiri"
    - path: "MrFunnyJokes/MrFunnyJokes/Views/SettingsView.swift"
      provides: "SiriTipView for discoverability"
      contains: "SiriTipView"
  key_links:
    - from: "JokeViewModel.swift"
      to: "SharedStorageService"
      via: "saveCachedJokesForSiri call"
      pattern: "sharedStorage\\.saveCachedJokesForSiri"
    - from: "SettingsView.swift"
      to: "TellJokeIntent"
      via: "SiriTipView intent"
      pattern: "SiriTipView\\(intent:"
---

<objective>
Integrate Siri caching into the main app and verify on physical device.

Purpose: Complete the Siri integration by wiring up joke caching when the app fetches jokes, adding discoverability via SiriTipView, and verifying the full flow on a physical device.

Output:
- JokeViewModel caches jokes for Siri access on every fetch
- Settings screen shows SiriTipView for command discovery
- Verified working Siri integration on physical device
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-siri-integration/03-CONTEXT.md
@.planning/phases/03-siri-integration/03-01-SUMMARY.md

# Files to modify
@MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift
@MrFunnyJokes/MrFunnyJokes/Views/SettingsView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire Siri caching into JokeViewModel</name>
  <files>
    MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift
  </files>
  <action>
Add Siri cache population to JokeViewModel. When jokes are fetched from Firestore, also cache them for Siri access.

1. In `fetchInitialAPIContent()`, after caching jokes by category and before the comment "Apply user ratings from local storage", add:
   ```swift
   // Cache jokes for Siri access (offline support)
   sharedStorage.saveCachedJokesForSiri(from: newJokes)
   ```

2. In `fetchInitialAPIContentBackground()`, add the same line in the same location:
   ```swift
   // Cache jokes for Siri access (offline support)
   sharedStorage.saveCachedJokesForSiri(from: newJokes)
   ```

3. In `refresh()`, after the grouped dictionary caching loop, add:
   ```swift
   // Update Siri cache with fresh jokes
   sharedStorage.saveCachedJokesForSiri(from: newJokes)
   ```

This ensures Siri always has access to recent jokes, updated whenever the main app fetches from Firestore.

Note: The sharedStorage property already exists in JokeViewModel (line 30: `private let sharedStorage = SharedStorageService.shared`), so no new properties needed.
  </action>
  <verify>
Build succeeds: `xcodebuild -project MrFunnyJokes/MrFunnyJokes.xcodeproj -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | tail -20`
Grep for Siri caching: `grep -n "saveCachedJokesForSiri" MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift`
  </verify>
  <done>
JokeViewModel calls saveCachedJokesForSiri in fetchInitialAPIContent, fetchInitialAPIContentBackground, and refresh.
Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add SiriTipView to Settings for discoverability</name>
  <files>
    MrFunnyJokes/MrFunnyJokes/Views/SettingsView.swift
  </files>
  <action>
Add SiriTipView to the Settings screen so users can discover the Siri command.

1. Add import at top if not present:
   ```swift
   import AppIntents
   ```

2. Find a good location in the Settings view - likely near the notifications section or as its own section. Add a new Section:
   ```swift
   Section {
       SiriTipView(intent: TellJokeIntent())
           .siriTipViewStyle(.automatic)
   } header: {
       Text("Siri")
   } footer: {
       Text("Say this to get a random joke without opening the app.")
   }
   ```

The SiriTipView automatically shows the configured phrase and dismisses permanently once the user interacts with it. It's the native way to teach users about Siri shortcuts.

Place this section in a logical location - after notifications settings is a good spot since both relate to "getting jokes delivered to you."
  </action>
  <verify>
Build succeeds: `xcodebuild -project MrFunnyJokes/MrFunnyJokes.xcodeproj -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | tail -20`
Verify SiriTipView added: `grep -n "SiriTipView" MrFunnyJokes/MrFunnyJokes/Views/SettingsView.swift`
  </verify>
  <done>
SettingsView imports AppIntents.
SiriTipView displays in Settings with TellJokeIntent.
Build succeeds.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete Siri integration:
- TellJokeIntent that speaks jokes aloud
- JokeSnippetView showing character avatar and joke text
- Auto-registered App Shortcut in Shortcuts app
- SiriTipView in Settings for discoverability
- Automatic joke caching for offline Siri access
  </what-built>
  <how-to-verify>
**IMPORTANT: Siri integration MUST be tested on a physical device. Simulator cannot fully test voice commands.**

1. **Build and run on physical iPhone:**
   - Connect iPhone to Mac
   - Select the device in Xcode
   - Build and run the app
   - Wait for app to launch and load jokes (this caches them for Siri)

2. **Verify App Shortcut registration:**
   - Open the Shortcuts app on iPhone
   - Search for "Mr. Funny Jokes" or "Tell Me a Joke"
   - Expected: "Tell Me a Joke" shortcut appears

3. **Test via Shortcuts app first (easier to debug):**
   - Tap the "Tell Me a Joke" shortcut in Shortcuts app
   - Expected: Siri speaks a joke aloud (character intro + setup + punchline)
   - Expected: Visual snippet shows character avatar and joke text

4. **Test via voice command:**
   - Say "Hey Siri, tell me a joke from Mr. Funny Jokes"
   - Expected: Siri responds with a spoken joke
   - Expected: Visual snippet displays

5. **Verify Settings discoverability:**
   - Open app Settings tab
   - Expected: SiriTipView shows the voice command phrase
   - Tap the tip to dismiss (it won't appear again)

6. **Test offline mode (optional but recommended):**
   - Enable Airplane Mode
   - Use Shortcuts app to trigger "Tell Me a Joke"
   - Expected: Still works (uses cached jokes)

**If issues occur:**
- Siri says "I don't have any jokes cached" -> Open app first to load jokes
- Shortcut doesn't appear -> Delete and reinstall app, wait a minute
- Phrase not recognized -> Try exact phrase: "Tell me a joke from Mr. Funny Jokes"
  </how-to-verify>
  <resume-signal>Type "approved" if Siri speaks jokes correctly, or describe any issues encountered.</resume-signal>
</task>

</tasks>

<verification>
Physical device verification is required. After human approval:

1. Confirm Siri speaks jokes aloud (SIRI-02)
2. Confirm App Shortcut appears in Shortcuts app (SIRI-04)
3. Confirm voice trigger works "Hey Siri, tell me a joke from Mr. Funny Jokes" (SIRI-01)
4. Confirm offline mode works via cached jokes (SIRI-03)
</verification>

<success_criteria>
- JokeViewModel caches jokes for Siri on fetch
- SiriTipView appears in Settings
- App Shortcut visible in Shortcuts app
- Siri speaks joke setup and punchline aloud
- Visual snippet displays correctly
- Offline mode works using cached jokes
- User approves all verification steps
</success_criteria>

<output>
After completion, create `.planning/phases/03-siri-integration/03-02-SUMMARY.md`
</output>
