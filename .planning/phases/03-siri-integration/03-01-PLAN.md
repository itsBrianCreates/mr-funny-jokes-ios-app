---
phase: 03-siri-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - MrFunnyJokes/MrFunnyJokes/Intents/TellJokeIntent.swift
  - MrFunnyJokes/MrFunnyJokes/Intents/JokeSnippetView.swift
  - MrFunnyJokes/MrFunnyJokes/Intents/MrFunnyShortcutsProvider.swift
  - MrFunnyJokes/Shared/SharedStorageService.swift
  - MrFunnyJokes/Shared/SharedJoke.swift
autonomous: true

must_haves:
  truths:
    - "TellJokeIntent compiles and conforms to AppIntent protocol"
    - "Siri can speak a joke when intent performs"
    - "Visual snippet displays character avatar and joke text"
    - "App Shortcut auto-registers with phrases containing app name"
  artifacts:
    - path: "MrFunnyJokes/MrFunnyJokes/Intents/TellJokeIntent.swift"
      provides: "AppIntent implementation for Siri"
      exports: ["TellJokeIntent"]
    - path: "MrFunnyJokes/MrFunnyJokes/Intents/JokeSnippetView.swift"
      provides: "SwiftUI view for Siri visual snippet"
      exports: ["JokeSnippetView", "EmptyJokeSnippetView"]
    - path: "MrFunnyJokes/MrFunnyJokes/Intents/MrFunnyShortcutsProvider.swift"
      provides: "Auto-registration of shortcuts"
      exports: ["MrFunnyShortcutsProvider"]
    - path: "MrFunnyJokes/Shared/SharedStorageService.swift"
      provides: "Joke caching methods for Siri"
      contains: "getRandomCachedJoke"
    - path: "MrFunnyJokes/Shared/SharedJoke.swift"
      provides: "Codable model for cached jokes"
      exports: ["SharedJoke"]
  key_links:
    - from: "TellJokeIntent.swift"
      to: "SharedStorageService.shared"
      via: "getRandomCachedJoke() call in perform()"
      pattern: "SharedStorageService\\.shared\\.getRandomCachedJoke"
    - from: "TellJokeIntent.swift"
      to: "JokeSnippetView"
      via: "ShowsSnippetView return"
      pattern: "JokeSnippetView\\(joke:"
    - from: "MrFunnyShortcutsProvider.swift"
      to: "TellJokeIntent"
      via: "AppShortcut intent"
      pattern: "intent:\\s*TellJokeIntent"
---

<objective>
Create the Siri integration infrastructure using App Intents framework.

Purpose: Enable voice-activated joke delivery where Siri speaks jokes aloud without opening the app. This addresses requirement SIRI-01 (trigger), SIRI-02 (spoken response), SIRI-03 (offline via cached jokes), and SIRI-04 (auto-registration).

Output:
- TellJokeIntent that fetches a random cached joke and returns spoken dialog + visual snippet
- JokeSnippetView showing character avatar and joke text
- MrFunnyShortcutsProvider for auto-registration with proper phrase format
- Extended SharedStorageService with joke caching for Siri access
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-siri-integration/03-CONTEXT.md
@.planning/phases/03-siri-integration/03-RESEARCH.md

# Existing codebase patterns
@MrFunnyJokes/Shared/SharedStorageService.swift
@MrFunnyJokes/Shared/SharedJokeOfTheDay.swift
@MrFunnyJokes/MrFunnyJokes/Models/Character.swift
@MrFunnyJokes/MrFunnyJokes/Models/Joke.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SharedJoke model and extend SharedStorageService</name>
  <files>
    MrFunnyJokes/Shared/SharedJoke.swift
    MrFunnyJokes/Shared/SharedStorageService.swift
  </files>
  <action>
Create SharedJoke.swift - a Codable model for jokes cached for Siri:
```swift
struct SharedJoke: Codable, Identifiable {
    let id: String
    let setup: String
    let punchline: String
    let character: String?  // Character ID (e.g., "mr_funny")
    let type: String?       // Joke type (e.g., "knock_knock", "dad_joke")

    var text: String { "\(setup) \(punchline)" }
}
```

Extend SharedStorageService.swift with methods for Siri joke caching:

1. Add private keys:
   - `cachedJokesKey = "cachedJokesForSiri"`
   - `recentlyToldKey = "recentlyToldJokeIds"`
   - `maxRecentlyTold = 10`

2. Add `saveCachedJokesForSiri(_ jokes: [SharedJoke])`:
   - Encode jokes array to JSON
   - Save to sharedDefaults

3. Add `getRandomCachedJoke() -> SharedJoke?`:
   - Load jokes from sharedDefaults
   - Get recently told IDs array
   - Filter to find unseen jokes
   - Select random from unseen (or any if all seen)
   - Track selected joke ID in recently told array (FIFO, max 10)
   - Return selected joke

4. Add convenience `saveCachedJokesForSiri(from jokes: [Joke])` that converts Joke array to SharedJoke array (for easy integration with JokeViewModel).

This provides the data layer Siri needs for offline access.
  </action>
  <verify>
Build succeeds: `xcodebuild -project MrFunnyJokes/MrFunnyJokes.xcodeproj -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | tail -20`
  </verify>
  <done>
SharedJoke model exists with id, setup, punchline, character, type fields.
SharedStorageService has saveCachedJokesForSiri and getRandomCachedJoke methods.
Build succeeds without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TellJokeIntent and snippet views</name>
  <files>
    MrFunnyJokes/MrFunnyJokes/Intents/TellJokeIntent.swift
    MrFunnyJokes/MrFunnyJokes/Intents/JokeSnippetView.swift
  </files>
  <action>
Create new folder `MrFunnyJokes/MrFunnyJokes/Intents/` for intent files.

Create TellJokeIntent.swift:
```swift
import AppIntents
import SwiftUI

struct TellJokeIntent: AppIntent {
    static var title: LocalizedStringResource = "Tell Me a Joke"
    static var description = IntentDescription("Tells a random joke from Mr. Funny Jokes")
    static var openAppWhenRun: Bool = false

    init() {}

    @MainActor
    func perform() async throws -> some IntentResult & ProvidesDialog & ShowsSnippetView {
        guard let joke = SharedStorageService.shared.getRandomCachedJoke() else {
            return .result(
                dialog: IntentDialog("I don't have any jokes cached right now. Open the app to load some!"),
                view: EmptyJokeSnippetView()
            )
        }

        let spokenText = formatJokeForSpeech(joke)
        return .result(
            dialog: IntentDialog(stringLiteral: spokenText),
            view: JokeSnippetView(joke: joke)
        )
    }

    private func formatJokeForSpeech(_ joke: SharedJoke) -> String {
        // Get character name - use JokeCharacter.find if available
        let characterName = getCharacterName(joke.character)

        if joke.type == "knock_knock" {
            // Knock-knock format with dramatic pauses (per CONTEXT.md)
            return "Here's one from \(characterName). \(joke.setup)... \(joke.punchline). Want another?"
        } else {
            // Standard joke format with natural pause
            return "Here's one from \(characterName). \(joke.setup)... \(joke.punchline). Want another?"
        }
    }

    private func getCharacterName(_ characterId: String?) -> String {
        guard let id = characterId else { return "Mr. Funny" }
        // Map character IDs to display names
        switch id {
        case "mr_funny": return "Mr. Funny"
        case "mr_potty": return "Mr. Potty"
        case "mr_bad": return "Mr. Bad"
        case "mr_love": return "Mr. Love"
        case "mr_sad": return "Mr. Sad"
        default: return "Mr. Funny"
        }
    }
}
```

Create JokeSnippetView.swift:
```swift
import SwiftUI

struct JokeSnippetView: View {
    let joke: SharedJoke

    private var characterImageName: String {
        switch joke.character {
        case "mr_funny": return "MrFunny"
        case "mr_potty": return "MrPotty"
        case "mr_bad": return "MrBad"
        case "mr_love": return "MrLove"
        case "mr_sad": return "MrSad"
        default: return "MrFunny"
        }
    }

    private var characterName: String {
        switch joke.character {
        case "mr_funny": return "Mr. Funny"
        case "mr_potty": return "Mr. Potty"
        case "mr_bad": return "Mr. Bad"
        case "mr_love": return "Mr. Love"
        case "mr_sad": return "Mr. Sad"
        default: return "Mr. Funny"
        }
    }

    var body: some View {
        VStack(alignment: .leading, spacing: 12) {
            HStack(spacing: 12) {
                Image(characterImageName)
                    .resizable()
                    .scaledToFit()
                    .frame(width: 48, height: 48)
                    .clipShape(Circle())

                Text(characterName)
                    .font(.headline)
            }

            Text(joke.text)
                .font(.body)
                .fixedSize(horizontal: false, vertical: true)
        }
        .padding()
        .frame(maxWidth: .infinity, alignment: .leading)
    }
}

struct EmptyJokeSnippetView: View {
    var body: some View {
        VStack(spacing: 8) {
            Image(systemName: "face.smiling")
                .font(.largeTitle)
            Text("No jokes cached")
                .font(.headline)
            Text("Open the app to load jokes")
                .font(.caption)
                .foregroundStyle(.secondary)
        }
        .padding()
    }
}
```

Note: The Intents folder needs to be added to the Xcode project. Create the folder and files, then add them to the MrFunnyJokes target in Xcode (the build step will reveal if files aren't included).
  </action>
  <verify>
Files exist at expected paths.
Build succeeds: `xcodebuild -project MrFunnyJokes/MrFunnyJokes.xcodeproj -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | tail -30`
  </verify>
  <done>
TellJokeIntent.swift exists with AppIntent conformance, openAppWhenRun=false, perform() returning dialog + snippet.
JokeSnippetView.swift exists with character avatar display and joke text.
EmptyJokeSnippetView exists for empty state.
Build succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create MrFunnyShortcutsProvider for auto-registration</name>
  <files>
    MrFunnyJokes/MrFunnyJokes/Intents/MrFunnyShortcutsProvider.swift
  </files>
  <action>
Create MrFunnyShortcutsProvider.swift:
```swift
import AppIntents

struct MrFunnyShortcutsProvider: AppShortcutsProvider {
    static var appShortcuts: [AppShortcut] {
        AppShortcut(
            intent: TellJokeIntent(),
            phrases: [
                "Tell me a joke from \(.applicationName)",
                "Tell me a joke with \(.applicationName)",
                "Give me a joke from \(.applicationName)"
            ],
            shortTitle: "Tell Me a Joke",
            systemImageName: "face.smiling"
        )
    }
}
```

CRITICAL: Every phrase MUST include `.applicationName` placeholder. Without it, Siri won't recognize the app name and shortcuts will fail to register. This is validated at compile time.

The shortTitle "Tell Me a Joke" is what appears in the Shortcuts app.
The systemImageName uses an SF Symbol that's appropriate for jokes.
  </action>
  <verify>
Build succeeds: `xcodebuild -project MrFunnyJokes/MrFunnyJokes.xcodeproj -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | tail -20`
Verify phrases contain applicationName: `grep -n "applicationName" MrFunnyJokes/MrFunnyJokes/Intents/MrFunnyShortcutsProvider.swift`
  </verify>
  <done>
MrFunnyShortcutsProvider.swift exists.
AppShortcut defined with TellJokeIntent.
All phrases contain `.applicationName` placeholder.
Build succeeds.
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build verification:
   ```bash
   xcodebuild -project MrFunnyJokes/MrFunnyJokes.xcodeproj -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build 2>&1 | grep -E "(error:|warning:|BUILD)"
   ```
   Expected: BUILD SUCCEEDED

2. File structure verification:
   ```bash
   ls -la MrFunnyJokes/MrFunnyJokes/Intents/
   ls -la MrFunnyJokes/Shared/SharedJoke.swift
   ```
   Expected: All files exist

3. Key pattern verification:
   ```bash
   grep -l "AppIntent" MrFunnyJokes/MrFunnyJokes/Intents/*.swift
   grep -l "AppShortcutsProvider" MrFunnyJokes/MrFunnyJokes/Intents/*.swift
   grep -l "getRandomCachedJoke" MrFunnyJokes/Shared/SharedStorageService.swift
   ```
   Expected: Files contain expected patterns
</verification>

<success_criteria>
- SharedJoke model created with Codable conformance
- SharedStorageService extended with Siri caching methods
- TellJokeIntent created with proper AppIntent conformance
- JokeSnippetView created with character avatar and joke display
- MrFunnyShortcutsProvider created with proper phrase format
- Project builds successfully
- All files added to Xcode project/target
</success_criteria>

<output>
After completion, create `.planning/phases/03-siri-integration/03-01-SUMMARY.md`
</output>
