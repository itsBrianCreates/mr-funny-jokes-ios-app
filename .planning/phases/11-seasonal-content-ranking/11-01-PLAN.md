---
phase: 11-seasonal-content-ranking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - MrFunnyJokes/MrFunnyJokes/Utilities/SeasonalHelper.swift
  - MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift
  - MrFunnyJokes/MrFunnyJokes/ViewModels/CharacterDetailViewModel.swift
autonomous: true

must_haves:
  truths:
    - "User scrolling the main feed in February sees Christmas jokes at the bottom, not mixed in with top-rated jokes"
    - "User scrolling the main feed in December sees Christmas jokes ranked by popularity alongside all other jokes"
    - "User browsing a character feed in February sees Christmas jokes demoted to the bottom"
    - "User applying a category filter still sees seasonal demotion in effect outside the holiday window"
  artifacts:
    - path: "MrFunnyJokes/MrFunnyJokes/Utilities/SeasonalHelper.swift"
      provides: "Christmas season detection and joke classification"
      contains: "isChristmasSeason"
    - path: "MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift"
      provides: "Seasonal demotion in main feed filteredJokes"
      contains: "isChristmasJoke"
    - path: "MrFunnyJokes/MrFunnyJokes/ViewModels/CharacterDetailViewModel.swift"
      provides: "Seasonal demotion in character feed filteredJokes"
      contains: "isChristmasJoke"
  key_links:
    - from: "MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift"
      to: "MrFunnyJokes/MrFunnyJokes/Utilities/SeasonalHelper.swift"
      via: "SeasonalHelper.isChristmasSeason and Joke tag check"
      pattern: "SeasonalHelper"
    - from: "MrFunnyJokes/MrFunnyJokes/ViewModels/CharacterDetailViewModel.swift"
      to: "MrFunnyJokes/MrFunnyJokes/Utilities/SeasonalHelper.swift"
      via: "SeasonalHelper.isChristmasSeason and Joke tag check"
      pattern: "SeasonalHelper"
---

<objective>
Add seasonal content ranking so Christmas-tagged jokes are demoted to the bottom of all feeds outside Nov 1 - Dec 31, and rank normally during the Christmas season.

Purpose: Users should see relevant, timely content at the top of their feed. Christmas jokes in February feel stale and push fresh content down.
Output: Modified feed sorting in JokeViewModel and CharacterDetailViewModel, plus a shared SeasonalHelper utility.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift
@MrFunnyJokes/MrFunnyJokes/ViewModels/CharacterDetailViewModel.swift
@MrFunnyJokes/MrFunnyJokes/Models/Joke.swift
@MrFunnyJokes/MrFunnyJokes/Utilities/HapticManager.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SeasonalHelper utility and add Joke extension</name>
  <files>MrFunnyJokes/MrFunnyJokes/Utilities/SeasonalHelper.swift</files>
  <action>
Create `SeasonalHelper.swift` in the Utilities folder with two pieces of functionality:

1. **`SeasonalHelper` enum** (not a class -- static utility, no state):
   - `static func isChristmasSeason(date: Date = Date()) -> Bool` -- returns true if the date falls within Nov 1 00:00 through Dec 31 23:59 (inclusive) using the **device's local calendar** (per Claude's Discretion: use device local timezone since users experience seasons locally). Extract month and day from `Calendar.current`. Month 11 (November) or month 12 (December) = in season.

2. **`Joke` extension** (in the same file, below `SeasonalHelper`):
   - `var isChristmasJoke: Bool` -- returns `true` if `tags` array contains `"christmas"` (case-sensitive, lowercase match per user decision). Use `tags?.contains("christmas") ?? false`.

Per user decision: ONLY check for `"christmas"` tag. Do NOT check for `"holidays"` tag. Other holiday tags (halloween, thanksgiving) are NOT affected.

Add the file to the main app target (MrFunnyJokes). Follow existing Utilities conventions -- see HapticManager.swift for file structure reference. Add `import Foundation` at top.

Add `// MARK: - Seasonal Content` section header comment before the SeasonalHelper enum.
  </action>
  <verify>
Build the project with `xcodebuild build -project MrFunnyJokes/MrFunnyJokes.xcodeproj -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 16' -quiet 2>&1 | tail -5` to confirm no compile errors. Verify the file exists and contains both `isChristmasSeason` and `isChristmasJoke`.
  </verify>
  <done>SeasonalHelper.swift exists in Utilities/ with isChristmasSeason() function and Joke.isChristmasJoke computed property. Project compiles without errors.</done>
</task>

<task type="auto">
  <name>Task 2: Apply seasonal demotion to all feed sorting</name>
  <files>MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift, MrFunnyJokes/MrFunnyJokes/ViewModels/CharacterDetailViewModel.swift</files>
  <action>
Modify the `filteredJokes` computed property in BOTH ViewModels to demote Christmas jokes outside the season window.

**JokeViewModel.filteredJokes** (currently at line ~57-81):

The current logic is:
1. Apply category filter
2. Filter to unrated only (with session-rated exception)
3. Sort by popularityScore descending

Add a Step 4 after Step 3's sort: Apply seasonal demotion. The approach:

```swift
// Step 4: Apply seasonal demotion for Christmas jokes outside Nov 1 - Dec 31
if !SeasonalHelper.isChristmasSeason() {
    let nonChristmas = sorted.filter { !$0.isChristmasJoke }
    let christmas = sorted.filter { $0.isChristmasJoke }
    return nonChristmas + christmas
} else {
    return sorted
}
```

This preserves the existing popularity sort within each group -- non-Christmas jokes keep their popularity order, and demoted Christmas jokes keep their relative popularity order among themselves (per Claude's Discretion: sort within demoted group by popularity).

Store the Step 3 result in a `let sorted = ...` variable (rename from the current inline return) so Step 4 can partition it.

**CharacterDetailViewModel.filteredJokes** (currently at line ~66-71):

The current logic just filters by category. It does NOT sort by popularity (the initial load uses `sortJokesForFreshFeed` which shuffles by freshness tiers). Apply the same demotion pattern:

```swift
var filteredJokes: [Joke] {
    let categoryFiltered: [Joke]
    if let category = selectedJokeType {
        categoryFiltered = jokes.filter { $0.category == category }
    } else {
        categoryFiltered = jokes
    }

    // Apply seasonal demotion for Christmas jokes outside Nov 1 - Dec 31
    if !SeasonalHelper.isChristmasSeason() {
        let nonChristmas = categoryFiltered.filter { !$0.isChristmasJoke }
        let christmas = categoryFiltered.filter { $0.isChristmasJoke }
        return nonChristmas + christmas
    } else {
        return categoryFiltered
    }
}
```

Add `// MARK: - Seasonal Content Ranking` comment above the seasonal demotion block in both files.

IMPORTANT: Do NOT modify `sortJokesForFreshFeed()` or any other sorting method. The seasonal demotion happens at the `filteredJokes` computed property level, which is the final output consumed by views. This ensures it applies consistently regardless of how jokes were loaded or sorted.

IMPORTANT: Do NOT touch the Me tab rated joke properties (ratedJokes, hilariousJokes, etc.) -- seasonal demotion only applies to the feed, not the user's rated collection.
  </action>
  <verify>
Build the project with `xcodebuild build -project MrFunnyJokes/MrFunnyJokes.xcodeproj -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 16' -quiet 2>&1 | tail -5` to confirm no compile errors. Grep both ViewModel files for `isChristmasJoke` and `SeasonalHelper` to confirm the demotion logic is present in both.
  </verify>
  <done>Both JokeViewModel.filteredJokes and CharacterDetailViewModel.filteredJokes apply seasonal demotion. Christmas-tagged jokes are pushed to the bottom of all feeds when outside Nov 1 - Dec 31. During the season, jokes sort normally. Project compiles without errors.</done>
</task>

</tasks>

<verification>
1. Build succeeds: `xcodebuild build` completes without errors
2. SeasonalHelper.swift exists with `isChristmasSeason()` and `Joke.isChristmasJoke`
3. JokeViewModel.filteredJokes contains seasonal demotion logic
4. CharacterDetailViewModel.filteredJokes contains seasonal demotion logic
5. No changes to Me tab sorting (ratedJokes, hilariousJokes, etc.)
6. No changes to sortJokesForFreshFeed or other internal sort methods
7. Today (February 2026) is outside the season window, so Christmas jokes will be demoted immediately upon build and run
</verification>

<success_criteria>
- Christmas-tagged jokes appear at the bottom of the main feed (currently February = outside season)
- Christmas-tagged jokes appear at the bottom of character feeds
- Christmas-tagged jokes appear at the bottom even when a category filter is applied
- Non-Christmas jokes maintain their existing popularity/freshness sort order
- No regressions: Me tab, ratings, infinite scroll, pull-to-refresh all work as before
</success_criteria>

<output>
After completion, create `.planning/phases/11-seasonal-content-ranking/11-01-SUMMARY.md`
</output>
