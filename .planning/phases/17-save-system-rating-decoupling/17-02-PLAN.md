---
phase: 17-save-system-rating-decoupling
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - MrFunnyJokes/MrFunnyJokes/Views/JokeDetailSheet.swift
  - MrFunnyJokes/MrFunnyJokes/Views/JokeCardView.swift
  - MrFunnyJokes/MrFunnyJokes/Views/CharacterDetailView.swift
  - MrFunnyJokes/MrFunnyJokes/Views/MeView.swift
  - MrFunnyJokes/MrFunnyJokes/Views/JokeOfTheDayView.swift
  - MrFunnyJokes/MrFunnyJokes/Views/AllTimeTopTen/RankedJokeCard.swift
  - MrFunnyJokes/MrFunnyJokes/App/MrFunnyJokesApp.swift
  - MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift
  - MrFunnyJokes/MrFunnyJokes/Views/SearchView.swift
  - MrFunnyJokes/MrFunnyJokes/Views/JokeFeedView.swift
autonomous: true

must_haves:
  truths:
    - "User can tap a Save button in the joke detail sheet to save a joke without rating it"
    - "Save button toggles between Save and Saved states with visual feedback"
    - "Rating a joke does NOT cause it to appear in the Me tab -- only saving does"
    - "Rating icon on joke cards still works and the joke sheet still displays the user's existing rating"
    - "Me tab shows saved jokes, not rated jokes"
    - "Swipe-to-delete in Me tab unsaves the joke (does not remove the rating)"
  artifacts:
    - path: "MrFunnyJokes/MrFunnyJokes/Views/JokeDetailSheet.swift"
      provides: "Save/Saved toggle button between rating section and Copy/Share"
      contains: "onSave"
    - path: "MrFunnyJokes/MrFunnyJokes/Views/MeView.swift"
      provides: "Saved-jokes display with date ordering, no segmented control"
      contains: "savedJokes"
    - path: "MrFunnyJokes/MrFunnyJokes/Views/JokeCardView.swift"
      provides: "onSave callback passed through to JokeDetailSheet"
      contains: "onSave"
  key_links:
    - from: "JokeDetailSheet"
      to: "onSave callback"
      via: "Save button tap triggers onSave closure"
      pattern: "onSave"
    - from: "All 8 JokeDetailSheet call sites (6 functional + 2 preview)"
      to: "ViewModel.saveJoke()"
      via: "onSave closure calling saveJoke or equivalent"
      pattern: "onSave.*saveJoke"
    - from: "MeView"
      to: "viewModel.savedJokes"
      via: "ForEach iterating saved jokes instead of rated jokes"
      pattern: "savedJokes"
---

<objective>
Add Save button to JokeDetailSheet, wire onSave callback through all 8 call sites (6 functional + 2 preview), and rewire MeView to display saved jokes instead of rated jokes.

Purpose: Complete the user-facing UI for the save system -- users see and interact with the Save button, and the Me tab reflects their saved collection.
Output: Working Save button in all joke detail sheets, MeView showing saved jokes with proper empty state, swipe-to-unsave behavior.
</objective>

<execution_context>
@/Users/brianvanaski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brianvanaski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-save-system-rating-decoupling/17-RESEARCH.md
@.planning/phases/17-save-system-rating-decoupling/17-01-SUMMARY.md
@MrFunnyJokes/MrFunnyJokes/Views/JokeDetailSheet.swift
@MrFunnyJokes/MrFunnyJokes/Views/JokeCardView.swift
@MrFunnyJokes/MrFunnyJokes/Views/CharacterDetailView.swift
@MrFunnyJokes/MrFunnyJokes/Views/MeView.swift
@MrFunnyJokes/MrFunnyJokes/Views/JokeOfTheDayView.swift
@MrFunnyJokes/MrFunnyJokes/Views/AllTimeTopTen/RankedJokeCard.swift
@MrFunnyJokes/MrFunnyJokes/App/MrFunnyJokesApp.swift
@MrFunnyJokes/MrFunnyJokes/Views/SearchView.swift
@MrFunnyJokes/MrFunnyJokes/Views/JokeFeedView.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Save button to JokeDetailSheet and wire onSave through all 8 call sites (6 functional + 2 preview)</name>
  <files>
    MrFunnyJokes/MrFunnyJokes/Views/JokeDetailSheet.swift
    MrFunnyJokes/MrFunnyJokes/Views/JokeCardView.swift
    MrFunnyJokes/MrFunnyJokes/Views/CharacterDetailView.swift
    MrFunnyJokes/MrFunnyJokes/Views/JokeOfTheDayView.swift
    MrFunnyJokes/MrFunnyJokes/Views/AllTimeTopTen/RankedJokeCard.swift
    MrFunnyJokes/MrFunnyJokes/App/MrFunnyJokesApp.swift
    MrFunnyJokes/MrFunnyJokes/Views/SearchView.swift
    MrFunnyJokes/MrFunnyJokes/Views/JokeFeedView.swift
  </files>
  <action>
**JokeDetailSheet.swift** -- Add onSave parameter and Save button:

1. Add `let onSave: () -> Void` to the struct properties, after `let onRate: (Int) -> Void`.

2. Add a Save/Saved toggle button in the body, positioned between the BinaryRatingView section and the Copy/Share action buttons (find the Divider or spacing between them). The button should look like:
   ```swift
   Button {
       onSave()
       HapticManager.shared.lightTap()
   } label: {
       HStack(spacing: 8) {
           Image(systemName: joke.isSaved ? "person.fill" : "person")
               .contentTransition(.symbolEffect(.replace))
           Text(joke.isSaved ? "Saved" : "Save")
       }
       .frame(maxWidth: .infinity, minHeight: 24)
       .padding(.vertical, 14)
   }
   .buttonStyle(.bordered)
   .tint(joke.isSaved ? .yellow : .gray)
   ```
   Place this as its own visual section. Use the same spacing pattern as between the rating and action buttons.

3. Update BOTH preview providers in JokeDetailSheet.swift to include `onSave: {}`.

**All 8 call sites (6 functional + 2 preview)** -- Add `onSave` parameter to each `JokeDetailSheet(` instantiation. Find all sites by searching for `JokeDetailSheet(` in the codebase. The research identified these locations:

1. **JokeCardView.swift** (~line 81): Add `onSave: { viewModel.saveJoke(joke) }` -- check how `viewModel` is referenced here. If JokeCardView uses callback closures instead of a direct viewModel reference, add an `onSave` closure parameter to JokeCardView itself (alongside `onShare`, `onCopy`, `onRate`) and pass it through. Then update all JokeCardView instantiation sites to provide the onSave closure.

2. **CharacterDetailView.swift** (~line 274): The CharacterJokeCardView sheet. Add `onSave: { viewModel.saveJoke(joke) }` where `viewModel` is the CharacterDetailViewModel. Check how the joke variable is referenced in scope.

3. **MeView.swift** (~line 117): Add `onSave: { viewModel.saveJoke(joke) }` where `viewModel` is JokeViewModel.

4. **JokeOfTheDayView.swift** (~line 130): Add `onSave` closure. Check how rating is handled here -- likely through a callback. Add matching `onSave` parameter if needed.

5. **RankedJokeCard.swift** (~line 105): Add `onSave` closure. Check the pattern -- RankedJokeCard may use callbacks. If so, add `onSave` as a closure parameter to RankedJokeCard and wire through.

6. **MrFunnyJokesApp.swift** (~line 195): The deep-link JOTD sheet. Add `onSave: { viewModel.saveJoke(joke) }`.

7. **JokeDetailSheet.swift previews** (~lines 234, 255): Already handled in step 3 above.

**CRITICAL:** If JokeCardView uses callback closures (`onShare`, `onCopy`, `onRate`), then you must:
- Add `let onSave: () -> Void` to JokeCardView's properties
- Pass it through to JokeDetailSheet
- Update ALL JokeCardView instantiation sites to provide `onSave`. Known sites:
  - **JokeFeedView.swift** (~line 105): Instantiates JokeCardView with callbacks
  - **SearchView.swift** (~line 132): Instantiates JokeCardView with callbacks
  - **JokeCardView.swift previews** (~lines 122, 135, 149, 164): Preview providers

Search for `JokeCardView(` across the codebase to confirm no others exist.

Similarly, if RankedJokeCard or JokeOfTheDayView need new closure parameters, trace their usage and update all instantiation sites.

**Do not leave any compile errors.** Every instantiation site of every modified view must be updated.
  </action>
  <verify>Build the project: `xcodebuild build -project MrFunnyJokes/MrFunnyJokes.xcodeproj -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 17 Pro' -quiet 2>&1 | tail -10`. Zero errors. Then: `grep -rn 'onSave' MrFunnyJokes/MrFunnyJokes/Views/ MrFunnyJokes/MrFunnyJokes/App/` should show onSave at every JokeDetailSheet call site.</verify>
  <done>Save button appears in JokeDetailSheet between rating and copy/share. All 8 JokeDetailSheet call sites pass onSave. All intermediate views (JokeCardView, RankedJokeCard, etc.) updated with onSave if they use callback patterns. Project compiles with zero errors.</done>
</task>

<task type="auto">
  <name>Task 2: Rewire MeView to show saved jokes and clean up dead rated-joke code</name>
  <files>
    MrFunnyJokes/MrFunnyJokes/Views/MeView.swift
    MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift
  </files>
  <action>
**MeView.swift** -- Complete rewrite of MeView to show saved jokes:

1. **Remove segmented control:** Delete `@State private var selectedType: RankingType = .hilarious`. Remove the `currentJokes` computed property. Remove the `jokesCount(for:)` function. Remove the `Picker` section. Remove the `EmptyStateView(type:)` for per-segment empty state.

2. **Replace empty state check:** Change `viewModel.ratedJokes.isEmpty` to `viewModel.savedJokes.isEmpty`. Update empty state text:
   - Icon: `"person.slash"` (instead of `"star.slash"`)
   - Title: `"No Saved Jokes Yet"`
   - Subtitle: `"Tap Save on any joke to start your collection!"`

3. **Replace content view:** Instead of the segmented List with `currentJokes`, show a flat List of `viewModel.savedJokes`:
   ```swift
   List {
       ForEach(viewModel.savedJokes) { joke in
           jokeCard(for: joke)
               .listRowBackground(Color.clear)
               .listRowSeparator(.hidden)
               .listRowInsets(EdgeInsets(top: 6, leading: 16, bottom: 6, trailing: 16))
               .swipeActions(edge: .trailing) {
                   Button(role: .destructive) {
                       viewModel.unsaveJoke(joke)
                   } label: {
                       Label("Unsave", systemImage: "person.badge.minus")
                   }
                   .tint(.red)
               }
       }
   }
   .listStyle(.plain)
   ```
   **IMPORTANT:** The swipe action calls `viewModel.unsaveJoke(joke)` (NOT `viewModel.rateJoke(joke, rating: 0)`). This unsaves without removing the rating.

4. **Keep the sheet presentation:** Keep the `.sheet(isPresented:)` with JokeDetailSheet, but make sure `onSave` is wired (already done in Task 1).

**NOTE:** Rating indicators on saved joke cards (METB-03) are deferred to Phase 18.

**JokeViewModel.swift** -- Remove dead rated-joke code:

1. **Remove `ratedJokes` computed property** (line ~93) -- it was only used by MeView's empty state check, which now uses `savedJokes`.
2. **Remove `hilariousJokes` computed property** (line ~98) -- it was only used by MeView's segment display.
3. **Remove `horribleJokes` computed property** (line ~102) -- it was only used by MeView's segment display.

**Verify no other consumers first:** Grep for `ratedJokes`, `hilariousJokes`, `horribleJokes` across the codebase (excluding the definitions themselves). The research confirmed these are only used in MeView. The `AllTimeRankingsViewModel` has its own `hilariousJokes`/`horribleJokes` properties (different type: `[RankedJoke]`), which are NOT affected.

If any other consumer exists, keep the property. Only remove if truly dead.
  </action>
  <verify>Build the project: `xcodebuild build -project MrFunnyJokes/MrFunnyJokes.xcodeproj -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 17 Pro' -quiet 2>&1 | tail -10`. Zero errors. Then verify: `grep -n 'ratedJokes\|hilariousJokes\|horribleJokes' MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift` should show zero hits (these properties are removed). `grep -n 'savedJokes' MrFunnyJokes/MrFunnyJokes/Views/MeView.swift` should show the new usage.</verify>
  <done>MeView displays saved jokes in newest-first order. Empty state says "No Saved Jokes Yet". Swipe-to-delete calls unsaveJoke (preserves rating). Dead ratedJokes/hilariousJokes/horribleJokes removed from JokeViewModel. Project compiles.</done>
</task>

</tasks>

<verification>
1. Build succeeds with zero errors
2. `grep -rn 'onSave' MrFunnyJokes/MrFunnyJokes/` -- shows hits in JokeDetailSheet (definition + button), all call sites
3. `grep -rn 'savedJokes' MrFunnyJokes/MrFunnyJokes/Views/MeView.swift` -- confirms Me tab uses savedJokes
4. `grep -rn 'unsaveJoke' MrFunnyJokes/MrFunnyJokes/Views/MeView.swift` -- confirms swipe-to-delete calls unsave
5. `grep -rn 'ratedJokes' MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift` -- should be 0 hits (dead code removed)
6. `grep -rn 'person.fill' MrFunnyJokes/MrFunnyJokes/Views/JokeDetailSheet.swift` -- confirms Save button icon
</verification>

<success_criteria>
- Save button visible in JokeDetailSheet between rating and copy/share sections
- Save button toggles between "Save" (person icon) and "Saved" (person.fill icon) with haptic feedback
- All 8 JokeDetailSheet call sites wire onSave to the appropriate ViewModel's saveJoke method
- Me tab shows saved jokes (not rated jokes), ordered newest-first
- Me tab empty state says "No Saved Jokes Yet"
- Swipe-to-delete in Me tab unsaves the joke without removing the rating
- Dead ratedJokes/hilariousJokes/horribleJokes computed properties removed from JokeViewModel
- Project builds with zero compile errors
</success_criteria>

<output>
After completion, create `.planning/phases/17-save-system-rating-decoupling/17-02-SUMMARY.md`
</output>
