---
phase: 10-bug-fixes-ux-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift
  - MrFunnyJokes/MrFunnyJokes/Views/YouTubePromoCardView.swift
  - MrFunnyJokes/MrFunnyJokes/Views/JokeFeedView.swift
autonomous: true

must_haves:
  truths:
    - "User rates joke, closes app, reopens - joke appears in Me tab"
    - "User pulls to refresh Me tab - rated jokes remain visible"
    - "User taps X on YouTube promo - promo disappears immediately"
    - "User taps Subscribe button - promo hidden on next session"
    - "User closes and reopens app - promo dismissal persists"
  artifacts:
    - path: "MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift"
      provides: "Rating persistence fix in loadInitialContentAsync"
      contains: "applyStoredRatings"
    - path: "MrFunnyJokes/MrFunnyJokes/Views/YouTubePromoCardView.swift"
      provides: "Promo dismissal UI and state"
      contains: "@AppStorage"
    - path: "MrFunnyJokes/MrFunnyJokes/Views/JokeFeedView.swift"
      provides: "Conditional promo rendering based on dismissal state"
      contains: "youtubePromoDismissed"
  key_links:
    - from: "JokeFeedView.swift"
      to: "YouTubePromoCardView.swift"
      via: "onDismiss callback"
      pattern: "onDismiss.*youtubePromoDismissed"
    - from: "JokeViewModel.swift"
      to: "LocalStorageService.swift"
      via: "getRating call on cached jokes"
      pattern: "storage\\.getRating"
---

<objective>
Fix Me tab persistence bug and add YouTube promo dismissal functionality.

Purpose: Users should see their rated jokes persist across app sessions (Me tab bug), and be able to dismiss the YouTube promo card either via X button or after tapping Subscribe (UX polish).

Output:
- JokeViewModel with consistent rating application on all load paths
- YouTubePromoCardView with X dismiss button and @AppStorage persistence
- JokeFeedView with conditional promo rendering
</objective>

<execution_context>
@/Users/brianvanaski/.claude/get-shit-done/workflows/execute-plan.md
@/Users/brianvanaski/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-bug-fixes-ux-polish/10-RESEARCH.md
@MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift
@MrFunnyJokes/MrFunnyJokes/Views/YouTubePromoCardView.swift
@MrFunnyJokes/MrFunnyJokes/Views/JokeFeedView.swift
@MrFunnyJokes/MrFunnyJokes/Services/LocalStorageService.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix Me tab rating persistence bug</name>
  <files>MrFunnyJokes/MrFunnyJokes/ViewModels/JokeViewModel.swift</files>
  <action>
In `loadInitialContentAsync()`, after loading cached jokes via `storage.loadAllCachedJokesAsync()`, the jokes are passed to `sortJokesForFreshFeed()` but ratings should already be applied by `loadAllCachedJokesAsync()`.

However, there's a subtle bug: when jokes are loaded from cache AND Firebase updates them in `fetchInitialAPIContentBackground()`, the Firebase jokes correctly apply ratings. But if the app is closed before Firebase fetch completes, the cached jokes (which DO have ratings applied) are sorted and assigned to `jokes`.

The actual issue: Verify that `loadAllCachedJokesAsync()` in LocalStorageService applies ratings from the authoritative `jokeRatings` UserDefaults key (not from the cached joke's `userRating` field which may be stale).

**After investigation**: The `loadCachedJokesAsync(for:)` method at line 341-373 of LocalStorageService.swift loads ratings from UserDefaults and applies them (lines 356-366). This looks correct.

**The real bug**: In `loadInitialContentAsync()`, after `storage.loadAllCachedJokesAsync()` returns, the jokes DO have ratings applied. The issue might be that the `sortJokesForFreshFeed()` function relies on `cachedRatedIds` which may not be populated yet if `preloadMemoryCacheAsync()` hasn't finished loading the in-memory cache.

**Fix approach**:
1. In `loadInitialContentAsync()`, ensure ratings are explicitly re-applied after loading from cache, similar to how it's done in `fetchInitialAPIContent()` (lines 502-506)
2. Add an explicit rating application step after `loadAllCachedJokesAsync()` returns:

```swift
// PHASE 2: Load cached jokes asynchronously (off main thread)
let cached = await storage.loadAllCachedJokesAsync()

if !cached.isEmpty {
    // Ensure ratings are applied (defensive - cache should have them, but re-apply for consistency)
    let cachedWithRatings = cached.map { joke -> Joke in
        var mutableJoke = joke
        mutableJoke.userRating = storage.getRating(for: joke.id, firestoreId: joke.firestoreId)
        return mutableJoke
    }
    jokes = sortJokesForFreshFeed(cachedWithRatings)
    // ... rest of function
}
```

This ensures the authoritative rating source (`storage.getRating()`) is always used, matching the pattern in `fetchInitialAPIContent()`, `fetchInitialAPIContentBackground()`, `refresh()`, and `performLoadMore()`.
  </action>
  <verify>
1. Build succeeds: `xcodebuild -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build | head -50`
2. Manual test: Rate a joke, terminate app (not just background), reopen, check Me tab shows rated joke
  </verify>
  <done>
Cached jokes consistently have ratings applied via `storage.getRating()` call in `loadInitialContentAsync()`, matching all other load paths.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add YouTube promo dismissal functionality</name>
  <files>
MrFunnyJokes/MrFunnyJokes/Views/YouTubePromoCardView.swift
MrFunnyJokes/MrFunnyJokes/Views/JokeFeedView.swift
  </files>
  <action>
**Part A: Update YouTubePromoCardView.swift**

1. Add `onDismiss` callback parameter to the view:
```swift
var onDismiss: (() -> Void)?
```

2. Add an X dismiss button overlay in the top-right corner of the card:
```swift
.overlay(alignment: .topTrailing) {
    Button {
        HapticManager.shared.lightTap()
        onDismiss?()
    } label: {
        Image(systemName: "xmark.circle.fill")
            .font(.title3)
            .foregroundStyle(.secondary)
            .padding(8)
    }
    .buttonStyle(.plain)
}
```

3. Update the Subscribe button action to also call `onDismiss` after opening URL:
```swift
Button {
    HapticManager.shared.mediumImpact()
    openURL(youtubeURL)
    onDismiss?()  // Hide promo after subscribing
} label: {
    // ... existing label
}
```

4. Update the Preview to pass nil for onDismiss:
```swift
YouTubePromoCardView(onDismiss: nil)
```

**Part B: Update JokeFeedView.swift**

1. Add @AppStorage property for persistent dismissal state:
```swift
@AppStorage("youtubePromoDismissed") private var youtubePromoDismissed = false
```

2. Update `showYouTubePromo` computed property to check dismissal state:
```swift
private var showYouTubePromo: Bool {
    viewModel.selectedCategory == nil && !youtubePromoDismissed
}
```

3. Update both YouTubePromoCardView instantiations (lines 93 and 113) to pass onDismiss callback with animation:
```swift
YouTubePromoCardView(onDismiss: {
    withAnimation(.easeInOut(duration: 0.3)) {
        youtubePromoDismissed = true
    }
})
```

4. Add a transition to the promo card for smooth dismissal:
```swift
YouTubePromoCardView(onDismiss: {
    withAnimation(.easeInOut(duration: 0.3)) {
        youtubePromoDismissed = true
    }
})
.transition(.asymmetric(
    insertion: .opacity,
    removal: .opacity.combined(with: .scale(scale: 0.95))
))
```
  </action>
  <verify>
1. Build succeeds: `xcodebuild -scheme MrFunnyJokes -destination 'platform=iOS Simulator,name=iPhone 16 Pro' build | head -50`
2. Manual test:
   - Tap X on promo card - card disappears with animation
   - Tap Subscribe - opens YouTube, card hidden on return
   - Close and reopen app - promo stays hidden
  </verify>
  <done>
YouTube promo card has X dismiss button and Subscribe-triggered dismissal. Dismissal state persists via @AppStorage across app sessions. Smooth animation on dismissal.
  </done>
</task>

</tasks>

<verification>
1. **Me Tab Persistence:**
   - Open app, scroll feed, rate a joke (tap 5 stars)
   - Force-quit app (swipe up from app switcher)
   - Reopen app, navigate to Me tab
   - Rated joke should appear in appropriate category (Hilarious for 5 stars)

2. **Pull-to-Refresh Preserves Ratings:**
   - Rate multiple jokes in feed
   - Navigate to Me tab
   - Pull to refresh
   - All rated jokes should still be visible

3. **YouTube Promo X Dismiss:**
   - Open app, scroll to see YouTube promo card
   - Tap X button in top-right corner
   - Card should animate out
   - Scroll through feed - promo should not appear again

4. **YouTube Subscribe Dismissal:**
   - Reset: Clear app data or use fresh simulator
   - Open app, scroll to YouTube promo
   - Tap "Subscribe on YouTube" button
   - After returning to app, promo should be hidden

5. **Promo Dismissal Persistence:**
   - Dismiss promo via X or Subscribe
   - Force-quit app
   - Reopen app
   - Promo should remain hidden
</verification>

<success_criteria>
- All 5 verification scenarios pass
- No Xcode build warnings related to changes
- Haptic feedback triggers on promo X button tap
- Smooth animation on promo dismissal (no jarring UI)
- Me tab shows correct joke count after app restart
</success_criteria>

<output>
After completion, create `.planning/phases/10-bug-fixes-ux-polish/10-01-SUMMARY.md`
</output>
